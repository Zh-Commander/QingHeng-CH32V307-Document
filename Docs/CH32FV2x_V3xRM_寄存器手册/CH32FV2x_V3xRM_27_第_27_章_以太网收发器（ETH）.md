# 第 27 章 以太网收发器（ETH）

本章模块描述适用于 $\pmb { C H 3 2 V 3 x }$ 和CH32F20x微控制器系列部分产品。

本章提到的“以太网收发器”是一个专有名词，意为微控制器内部的以太网（Ethernet）数据链路层收发器，通讯速率最高为千兆位每秒（1Gbps），是一个通讯外设。本章提到的“MAC”指的是以太网收发器在数据链路层的角色名称，是以太网收发器的组成部分。

以太网收发器（Ethernet Transceiver MAC）是微控制器一个重要的高速通讯部件，它允许微控制器以千兆位（Gigabit）的连接速度接入以太网，实现极快的数据沟通。

## 27.1 CH32F20x_D8C、CH32V30x_D8C 系列

### 27.1.1 主要特征

微控制器的以太网收发器是微控制器的一个重要高速通讯外设，它集成千兆MAC（媒体访问控制器）、32位宽的DMA控制器、管理计数器（MMC）、精确时间协议控制器（PTP）和一个十兆速度的以太网物理层（10BASE-T PHY）。在外接千兆以太网物理层（PHY）后，它能以千兆位（1Gbps）的速度接入以太网进行数据收发。以太网收发器工作在数据链路层，需要通过软件实现 TCP/IP 协议栈和接口。以太网收发器支持标准MII、RMII和 RGMII三种 MII接口连接 PHY，如果用户要达到千兆的接入速度，必须使用 RGMII 接口；以太网收发器通过 SMI 接口控制 PHY，接口的时序由 MAC 自动实现，无需用户通过软件生成。RGMII接口支持发送时钟相位翻转和相对数据延迟，最大延迟 4 纳秒。以太网收发器的 MAC 支持标准 IEEE802.3 协议的以太网，支持魔法帧和特定唤醒帧。以太网收发器搭配的DMA 控制器以描述符的形式进行数据的收发管理和内存搬运，描述符的数量由用户根据沟通密集程度自行确定，DMA 控制器能以 32 位宽的速度向描述符指定的内存空间写入接收到的数据或从取出将发送的数据。此外，以太网收发器的MAC还支持 IEEE1588精确时间协议。

#### 27.1.1.1 MAC 特征

MAC 挂载在 AHB 总线上  
$\bullet$ 支持 10M/100M/1000M 以太网  
支持 MII/RMII/RGMII 接口  
RGMII支持发送时钟延迟和翻转  
$\bullet$ 支持全双工与半双工  
支持自动插入帧头序列和 SFD  
支持自动插入和校验CRC  
支持自动计算和校验IP/ICMP/TCP/UDP协议数据包的检验和  
支持发送帧长控制  
支持发送间隙调节  
支持 VLAN 帧  
支持帧接收地址的完美地址过滤、HASH 过滤  
支持帧发送地址过滤  
支持多播广播帧接收控制  
支持混杂模式  
$\bullet$ 支持 SMI 管理接口（RGMII 与 MII 各一套）  
$\bullet$ 支持魔法帧和自定义的唤醒帧唤醒微控制器  
$\bullet$ 支持专门的以太网唤醒中断入口  
支持链路层的数据回环

#### 27.1.1.2 DMA 特征

32 位宽的 MAC 专享 DMA

最大程度减小CPU的操作  
$\bullet$ DMA 挂载在 AHB 总线上，也同时做 AHB 总线的主设备直接访问 RAM  
$\bullet$ 支持以字节对齐方式访问RAM  
$\bullet$ 以描述符的方式管理收发缓冲区  
$\bullet$ 接收发送的一部分状态反馈在描述符中  
$\bullet$ 可以动态修改非正在使用的描述符和缓冲区  
$\bullet$ 支持手动停止或启动  
$\bullet$ 支持链式或环式的形式连接描述符  
支持收发完成中断等多种中断源

#### 27.1.1.3 MMC 模块特征

支持手动复位、停止或冻结  
$\bullet$ 多个支持发送和接收的多种计数模式的计数器  
支持多种中断

#### 27.1.1.4 PTP 模块特征

支持 IEEE 1588 协议  
$\bullet$ 支持自动在收发时保存当前的时刻  
$\bullet$ 自带一个 32 位的秒计时器和一个 32 位有符号的亚秒计时器  
支持以精调和粗调两种方式调节时间  
支持一个中断源  
支持 PPS 输出

#### 27.1.1.5 内部 10BASE-T 物理层特征

支持 10BASE-T  
$\bullet$ 通过 SMI 接口管理  
支持 MDIX 自动翻转  
支持 MDI接口的差分对 ${ \mathsf { p } } / { \mathsf { n } }$ 极性翻转  
$\bullet$ 支持手动复位  
$\bullet$ 支持物理层的数据回环  
支持半双工

### 27.1.2 概述

以太网收发器工作在 OSI 七层模型中的数据链路层和物理层。如果需要实现大于 10Mbps 的数据传输速率，需要外接百兆或千兆物理层芯片（PHY）实现物理连接。为了能在广泛使用的以太网中建立 IP、TCP 和 UDP 等协议的通讯，用户还需要用软件实现 TCP/IP 协议栈。以太网收发器由媒体访问控制层（MAC）、搭配的DMA及二者的控制寄存器及十兆物理层组成。

![](images/c92f5817876a258b21cd4175acea5107247ecaf7908f765aa3cd27cad0d64f24.jpg)  
图 27-1 以太网收发器在 OSI 模型和 TCP/IP 模型中的位置

以太网收发器的 MAC 按照 IEEE802.3 协议的规范设计，搭配 32 位宽的 DMA，保证数据能快速地从网线上转发到微控制器的内存中。以太网收发器拥有强大完整的 DMA 控制寄存器、MAC 控制寄存器和模式控制寄存器，微控制器的 CPU 通过 AHB 总线操作以太网收发器的寄存器。以太网收发器通过RGMII 接口和千兆以太网物理层连接，如果只需要百兆以太网的速度，则可以通过 MII 或 RMII 接口和百兆以太网物理层连接。以太网收发器的 MII、RMII 和 RGMII 接口的管脚是复用的，具体参看 27.3节。以太网收发器通过SMI接口管理以太网物理层。使用以太网收发器时，AHB总线的时钟不能低于50MHz。

![](images/0db63181ec9d8e4195e22d9000f638363f6b92586ef1fc878782aa9c111b6edc.jpg)  
图27-2 以太网收发器的结构框图

此外，以太网收发器还支持IEEE1588 精确时间协议（PTP），为微控制器系统或片外提供精确的时间数据。

### 27.1.3 以太网收发器使用引脚的分布和配置

微控制器支持三种MII接口，即标准MII、RMII和 RGMII。MII/RMII接口专用于十兆和百兆以太网物理层，RGMII接口可用于十兆、百兆和千兆以太网。下表显示了标准MII，RMII和 RGMII接口及内部物理层在封装引脚上的分布。

表 27-1 微控制器的媒体独立接口、内置物理层的介质相关接口  
及其他相关的引脚分布和需要进行的配置  

<table><tr><td>引脚</td><td>RGMII</td><td>RGMII的引脚配置</td><td>MII</td><td>RMII</td><td>MII/RMII的引脚配置</td></tr><tr><td>PA2</td><td>TXCLK</td><td></td><td colspan="2">MDIO</td><td>推挽复用输出</td></tr><tr><td>PC1</td><td>RXCTL</td><td>浮空输入</td><td colspan="2">MDC</td><td>推挽复用输出</td></tr><tr><td>PA1</td><td>RXD3</td><td>浮空输入</td><td>RX_CLK</td><td>REF_CLK</td><td>浮空输入</td></tr><tr><td>PA7</td><td>TXD0</td><td>推挽复用输出</td><td>RX_DV</td><td>CRS_DV</td><td>浮空输入</td></tr><tr><td>PC4</td><td>TXD1</td><td>推挽复用输出</td><td>RXD0</td><td>RXD0</td><td>浮空输入</td></tr><tr><td>PC5</td><td>TXD2</td><td>推挽复用输出</td><td>RXD1</td><td>RXD1</td><td>浮空输入</td></tr><tr><td>PB0</td><td>TXD3</td><td>推挽复用输出</td><td>RXD2</td><td></td><td>浮空输入</td></tr><tr><td>PB1</td><td>125MHz_IN</td><td>浮空输入</td><td>RXD3</td><td></td><td>浮空输入</td></tr><tr><td>PB10</td><td></td><td></td><td>RXER</td><td></td><td>浮空输入</td></tr><tr><td>PC3</td><td>RXD1</td><td>浮空输入</td><td>TX_CLK</td><td></td><td>浮空输入</td></tr><tr><td>PB11</td><td></td><td></td><td>TX_EN</td><td>TX_EN</td><td>推挽复用输出</td></tr><tr><td>PB12</td><td>MDC</td><td>推挽复用输出</td><td>TXD0</td><td>TXD0</td><td>推挽复用输出</td></tr><tr><td>PB13</td><td>MDIO</td><td>推挽复用输出</td><td>TXD1</td><td>TXD1</td><td>推挽复用输出</td></tr><tr><td>PC2</td><td>RXD0</td><td>浮空输入</td><td>TXD2</td><td></td><td>推挽复用输出</td></tr><tr><td>PB8</td><td></td><td></td><td>TXD3</td><td></td><td>推挽复用输出</td></tr><tr><td>PA0</td><td>RXD2</td><td>浮空输入</td><td>CRS</td><td></td><td>浮空输入</td></tr><tr><td>PA3</td><td>TXCTL</td><td>推挽复用输出</td><td>COL</td><td></td><td>浮空输入</td></tr><tr><td>PB5</td><td colspan="5">PPS_OUT(推挽复用输出)</td></tr><tr><td>PC6</td><td colspan="5">10BASE-T_TX_p(无需IO配置)</td></tr><tr><td>PC7</td><td colspan="5">10BASE-T_TX_n(无需IO配置)</td></tr><tr><td>PC8</td><td colspan="5">10BASE-T_RX_p(无需IO配置)</td></tr><tr><td>PC9</td><td colspan="5">10BASE-T_RX_n(无需IO配置)</td></tr></table>

### 27.1.4 物理层（PHY）管理和数据交互

以太网收发器的 MAC 通过站点管理接口（SMI 接口）对 PHY 进行管理，使用媒体独立接口（MII接口）与 PHY 进行数据交互。微控制器支持的 MII 接口包括标准 MII（一般就写为 MII）、精简 MII（RMII）和精简的千兆MII（RGMII）。微控制器在MII/RMII模式下和 RGMII模式下使用不同管脚引出SMI接口。

#### 27.1.4.1 SMI 接口

SMI 接口是一种串行通讯接口，使用MDC（时钟线）和MDIO（数据线）两线来访问 PHY的寄存器实现对PHY的管理，最多可以管理32个PHY芯片。其中 MDC是时钟线，空闲时保持低，MDIO 是数据线。SMI的读写操作和帧的组成都是由MAC主导的，用户只需要写入地址和数据。相关的寄存器分别为 MII 地址寄存器（R32_ETH_MACMIIAR）和 MII 数据寄存器（R32_ETH_MACMIIDR）。

#### 27.1.4.1.1 帧格式

SMI 接口管理帧的格式如下表 27-2 所示。

表 27-2 SMI 帧格式  

<table><tr><td></td><td>Preamble</td><td>STR</td><td>OP</td><td>PHY ADR</td><td>REG ADR</td><td>T</td><td>DATA</td><td>P</td></tr><tr><td>读</td><td>32个“1”</td><td>01</td><td>10</td><td>PPPPP</td><td>RRRRR</td><td>Z0</td><td>DCCCCCCCCCCCCCCCC</td><td>Z</td></tr><tr><td>写</td><td>32个“1”</td><td>01</td><td>01</td><td>PPPPP</td><td>RRRRR</td><td>10</td><td>DCCCCCCCCCCCCCCCC</td><td>Z</td></tr></table>

管理帧各域的定义如下：  
1） Preamble：先导符，由 32 个“1”组成，用于 MAC 和 PHY 同步；  
2） STR：起始符，固定为“01”；

3） OP：操作符，读为“10”，写为“01”；  
4） PHY ADR：物理层地址，5 位；  
5） REG ADR：寄存器地址，5 位；  
6） T：转换符，两位，用来切换MAC和PHY对 MDIO 线的控制权。在读操作时，MAC保持对 MDIO 线的高阻，PHY 对第一位保持高阻，对第二位下拉，并获取 MDIO 的控制权；在写操作时，MAC 对 MDIO线先置高再下拉，PHY对MDIO保持高阻状态，MAC保持对 MDIO的控制权；  
7） DATA：数据域，16 位，MAC 对 PHY 读写的数据，MSB 在前；  
8） P：MAC 和 PHY 都对 MDIO 保持高阻状态，但 PHY 的上拉电阻会把 MDIO 拉高。

#### 27.1.4.1.2 读写时序

写PHY寄存器操作如下：

当用户设置了 MII 写位（ETH_MACMIIAR:MW）和忙位(ETH_MACMIIAR:MB)，SMI 接口会向 PHY 发送PHY地址和寄存器地址，然后发送数据(ETH_MACMIIDR)。在 SMI接口发送数据的过程中，不能修改MII地址寄存器和 MII 数据寄存器的值；在此过程中,忙位保持为高，对 MII 地址寄存器或 MII 数据寄存器的写操作将被忽视，并且不对整个传输造成影响。当完成写操作时，SMI接口将清除忙位，用户可以根据忙位判断写操作结束。如图27-3的写部分。

读PHY寄存器操作如下：

当用户把以太网 MAC 的 MII 地址寄存器(ETH_MACMIIAR)的 MII 忙位置位，而保持 MII 写位复位时，SMI接口则发送PHY地址和寄存器地址，执行读 PHY寄存器的操作。在整个传输过程中，用户不能修改 MII 地址寄存器和 MII 数据寄存器的内容。在传输过程中，忙位保持为高，对 MII 地址寄存器或MII数据寄存器的写操作将被忽视，并且不影响整个传输的正确完成。在读操作完成后，SMI接口将清除忙位，并把从 PHY 读回的数据写入 MII 数据寄存器。如图 27-3 的读部分。

![](images/9e2643bf1d952f0d0e2acd24efd0c667d0d0607c2acfe8c4e04d71a7bc8da032.jpg)  
图 27-3 SMI 接口读写时速图

#### 27.1.4.1.3 SMI 时钟

一般来说 SMI 时钟需要保持在一个固定的范围，以保证实际上 SMI 的时钟需要被 PHY 接收。具体参考用户选用的 PHY芯片的手册。

SMI 时钟频率通过 MII 地址寄存器（ETH_MACMIIAR）的 CR 域从 AHB 时钟分频得到。下表显示和SMI时钟和AHB时钟的分频关系。默认选择42分频。

表 27-3 SMI 时钟和 AHB 时钟的分频关系  

<table><tr><td></td><td>适合搭配的 AHB 时钟的范围</td><td>SMI 时钟</td></tr><tr><td>0000b</td><td>60MHz 以上</td><td>AHB 时钟/42</td></tr><tr><td>0010b</td><td>20-35MHz</td><td>AHB 时钟/16</td></tr><tr><td>0011b</td><td>35-60MHz</td><td>AHB 时钟/26</td></tr></table>

<table><tr><td>其它值</td><td>无意义</td></tr></table>

#### 27.1.4.2 MII/RMII 接口

#### 27.1.4.2.1 概述

媒体独立接口（MII）是MAC和PHY进行数据沟通的接口，根据速度和引线数量区分，有标准MII、RMII、GMII、RGMII和SGMII等。媒体独立接口一般是有接收、发送各一组，每组由时钟线、若干数据线和辅助线组成。支持的MII接口为：标准 MII/RMII支持十兆和百兆物理层，RGMII 支持十兆、百兆和千兆物理层。由于市场上常用的物理层一般是 10M/100M 自动协商物理层、10M/100M/1000M 自动协商物理层，所以用户在使用 10M/100M 自动协商物理层时应该使用标准 MII/RMII 接口，在使用10M/100M/1000M 物理层时应该使用 RGMII 接口。

一般情况下，媒体独立接口发送方向（TX 开头）的时钟和数据是由 MAC发出的，接收方向（RX开头）的时钟和数据是由 PHY 发出的,但是 RMII 的时钟是公用的。同方向的引脚走线应注意等长布线，具体布线要点参看用户选用的物理层芯片的 Layout手册或本手册 27.1.4.2.2章节。

#### 27.1.4.2.2 引脚

MII 接口的引脚和功能如下：

表27-4 MII 接口的引脚和功能  

<table><tr><td>引脚</td><td>功能</td></tr><tr><td>TXC</td><td>发送时钟(2.5MHz或25MHz)</td></tr><tr><td>TXEN</td><td>发送数据使能</td></tr><tr><td>TXD0</td><td rowspan="4">发送数据线[0:3]</td></tr><tr><td>TXD1</td></tr><tr><td>TXD2</td></tr><tr><td>TXD3</td></tr><tr><td>RXC</td><td>接收时钟(2.5MHz或25MHz)</td></tr><tr><td>RXDV</td><td>指示接收数据有效</td></tr><tr><td>RXER</td><td>接收数据错误</td></tr><tr><td>RXD0</td><td rowspan="4">接收数据线[0:3]</td></tr><tr><td>RXD1</td></tr><tr><td>RXD2</td></tr><tr><td>RXD3</td></tr><tr><td>COL</td><td>冲突检测</td></tr><tr><td>CRS</td><td>载波检测</td></tr></table>

图 27-4 显示了使用 MII 接口的定义时，MAC 和 PHY 如何连接。

![](images/c8769c9661344b5a159bee999005bce151f15e9d9806523d9dee1d162d13d0c8.jpg)  
图 27-4 以太网收发器在使用 MII 规范时，MAC 和 PHY 如何接线

RMII接口的引脚和功能如下：

表 27-5 RMII 接口的引脚和功能  

<table><tr><td>引脚</td><td>功能</td></tr><tr><td>CLK_REF</td><td>收发时钟(50MHz)</td></tr><tr><td>TXEN</td><td>发送数据使能</td></tr><tr><td>TXDO</td><td rowspan="2">发送数据线[0:1]</td></tr><tr><td>TXD1</td></tr><tr><td>CRSDV</td><td>接收数据有效</td></tr><tr><td>RXD0</td><td rowspan="2">接收数据线[0:1]</td></tr><tr><td>RXD1</td></tr></table>

使用 RMII 接口时，收发时钟共用同一根线传输，时钟频率固定为 50MHz。当 RMII 使用在 10Mbps的速率时，RX 和 TX 每隔 10 个周期采样一个数据，数据线需要将数据保留 10 个周期；MAC 和 PHY 需要使用同一个时钟源。可以将 MAC 的 MCO 输出接到 PHY 的外部时钟源输入引脚上。图 27-5 显示了使用RMII接口时，MAC和PHY如何接线。

图 27-5 使用 RMII 接口时，MAC 和 PHY 的接线示意图  
![](images/f56e0f3169289883f05db550d7acc6e25b5d10f399c610ea082a0f7c7df0f3e9.jpg)  
注：以太网收发器需要从RXC引脚输入外界提供的REF_CLK 50MHz时钟频率。

#### 27.1.4.2.3 时序

RMII 和 MII 的时序的区别在于：

$\bullet$ RMII 的时钟固定为 $5 0 M H z$ ，而 MII 的收发时钟随着实际连接速度的不同而工作在 2.5MHz 或 25MHz；  
RMII 收发共用同一个时钟线；

RMII 是两位数据线，而 MII 是四位数据线。

如图 27-6 显示了 RMII 和 MII 的时序。

![](images/1483d6434c610af9b1ce4a9c791fdd3f1ff47181ce1a48e78f357efd94260f3c.jpg)  
图 27-6 MII 和 RMII 的时序图

#### 27.1.4.3 RGMII 接口

#### 27.1.4.3.1 引脚

RGMII 的引脚和功能如下表

表 27-6 RGMII 的引脚和功能  

<table><tr><td>引脚</td><td>功能</td></tr><tr><td>TXC</td><td>发送时钟</td></tr><tr><td>TXCTL</td><td>发送数据控制</td></tr><tr><td>TXD0</td><td rowspan="4">发送数据线[0:3]</td></tr><tr><td>TXD1</td></tr><tr><td>TXD2</td></tr><tr><td>TXD3</td></tr><tr><td>RXC</td><td>接收时钟</td></tr><tr><td>RXCTL</td><td>接收数据控制</td></tr><tr><td>RXD0</td><td rowspan="4">接收数据线[0:3]</td></tr><tr><td>RXD1</td></tr><tr><td>RXD2</td></tr><tr><td>RXD3</td></tr></table>

注：1.TXCTL/RXCTL在本微控制器的以太网收发器中用作收发数据有效信号来使用；  
有独立的 SMI 接口 。

#### 27.1.4.3.2 时序

RGMII工作在十兆和百兆速率的模式下，时序和MII类似；工作在千兆时，RGMII的时钟为125MHz，采用双边沿采样的方式。RGMII 不支持半双工。

由于 RGMII 使用双边沿采样且工作在 125MHz 的时钟频率下，因此电路设计人员应注意信号完整性问题。

RGMII的接收方接收到的时钟应相对数据滞后 $9 0 ^ { \circ }$ 以保证正确采样。以太网收发器设计了发送时钟延迟输出和相位翻转的功能。

![](images/848d61dfa81007f4bb54c0bb292c166925899e6c1dd54b6375d0ee7baa1533ed.jpg)  
图 27-7 RGMII 的时序示意图

#### 27.1.4.4 内部 10M 物理层使用时的注意事项

在置位扩展寄存器的内部物理层使能位时，所有的 MII相关的配置都将被无视，对 SMI接口的读写将直接映射到内部物理层，且忽略SMI接口写入的物理层地址。用户可以对内部物理层的寄存器进行访问以获取物理层连接状态，详见27.1.8.5章节。

#### 27.1.4.5 时钟产生和输出

#### 27.1.4.5.1 外设时钟源配置

![](images/1a84594ec30bb4174fc5854f1e5392f145c8afc5f708f4a95ce029f4e3cb0748.jpg)  
图 27-8 以太网外设时钟树

由上图可以看出，内部 10M 以太网物理层的时钟由 PLL3 提供，且必须为 60MHz。使用内部物理层时，需要把扩展寄存器的第2位置位，置位后，MII/RMII/RGMII 相关的设置均无效。

在使用MII时，收发时钟都由外部的物理层提供，为 2.5MHz或 25MHz。在使用 RMII 时，REF_CLK是唯一的时钟，从RXC引脚输入微控制器，固定为50MHz，使用RMII时需要将 AFIO 重映射寄存器中的第23位置位。

在使用 RGMII 时，MAC 需要频率为 125MHz 的时钟，由内部 PLL2/PLL3 的 VCO 产生(VCO 输出是 PLL输出频率的两倍)或外部输入，通过 EXT_125M 引脚输入 125MHz 时钟。RGMII 的发送时钟由 MAC 产生，

接收时钟由 PHY产生。开启RGMII需要在扩展寄存器中将第 3位置位，并在 RCC的第二个配置寄存器中将第22位置位，同时在[21:20]中选择合适的 125MHz 时钟源，详见官网 EVT例程。

#### 27.1.4.5.2 MCO 输出

已知 MCO 支持 HSE、HSI、系统主频、PLLCLK/2、PLL2CLK、PLL3CLK、PLL3CLK/2 和 XTI 这八种时钟的输出，用户可以利用 MCO 输出应用中所需要的频率，比如常见物理层芯片所需要的 25MHz 时钟，并以此节省一颗晶体。MCO 的输出频率不应大于 100MHz。

### 27.1.5 IEEE802.3 和 IEEE1588

IEEE802.3协议及其补充协议组成目前以太网的官方标准，它详细定义了目前使用的以太网的方方面面。我们可以认为以太网处于OSI模型中的物理层和数据链路层的一部分。本节在应用的角度上讨论IEEE802.3协议中用户需要用到的部分，即帧格式和 MAC地址相关的内容。同时，微控制器的以太网收发器还支持IEEE1588精确时间协议，本文还将讨论 IEEE1588的部分内容。

IEEE802.3协议构建的以太网模型中，数据传输单元是以太网帧。以太网帧在不同的介质上以不同的速率传输时有不同的编码形式，接收后经过物理层解码，通过 MII 接口发给 MAC，MAC 校验和过滤通过后，由TCP/IP协议栈提取出应用信息发给不同的应用进程。

#### 27.1.5.1 帧格式

以太网帧的帧格式如表 27-7 所示。

表 27-7 普通以太网帧格式  

<table><tr><td>前同步码</td><td>SFD</td><td>目标地址</td><td>源地址</td><td>长度或类型</td><td>数据域</td><td>CRC</td></tr><tr><td>7 Bytes</td><td>1Byte</td><td>6 Bytes</td><td>6 Bytes</td><td>2 Bytes</td><td>46-1500 Bytes</td><td>4 Bytes</td></tr><tr><td colspan="7">总长度：64至1518字节加上8字节的物理层首部（前同步码和SFD）</td></tr></table>

前同步码：56 位（7 字节）交替的低电平和高电平跳跃，值固定，用十六进制表示即为 $0 { \times } \tt A A { - } 0 { \times } \tt A \tt A { - }$ $0 \times A A - 0 \times A A - 0 \times A A - 0 \times A A - 0 \times A A = 1 1 A$ 。此域用来进行时钟同步。该域由硬件自动添加/去除，用户不需要理会。

SFD：帧首定界符，8 位（1 字节），值为 10101011b，SFD 用来提醒接收方这是最后一次进行时钟同步的机会，其后为目标地址。该字节由硬件自动添加/去除，用户不需要理会。

目标地址：发送这个帧的设备希望接收这个帧的设备地址，这里指的是硬件地址，又称 MAC地址，由 IEEE 为生产商分配，全球唯一，6 字节 48 位。本公司（WCH）的微控制器的 MAC 地址出厂时已烧录在芯片内部。地址的发送遵循低有效位在前的原则。

源地址：发送这个帧的设备的硬件地址。源地址必须为单播地址。

长度或类型：2字节，以太网一般用作类型，IEEE802.3标准中也用作长度，以1536（即 $0 \times 0 6 0 0 ^ { \cdot }$ ）分界，1536 以上表示协议，表示数据部分是根据何种上层协议组织起来的，例如 $0 \times 0 8 0 6$ 表示 ARP，$0 \times 0 8 0 0$ 表示 ${ \mathsf { I P v 4 } }$ ， $0 \times 8 6 { \mathsf { d d } }$ 表示IPv6；1536以下表示数据长度。

数据域：最小 46 字节，最大 1500 字节。当数据域不足 46 字节需要加填充增至 46 字节，超过1500 字节请另组一帧。数据域中装载着需要实际发送的数据。

CRC：循环冗余校验，此处用的是 CRC32 校验。

#### 27.1.5.2 帧发送

以太网收发器发送数据帧的时候，其专有的 DMA控制器从发送描述符（trans descript 在14.1.1节）指定的RAM中取出要发送的数据通过专用数据总线压进 MAC。FIFO的填充程度会返回到 DMA控制器中，当要发送的数据全部发送完，DMA 控制器会向 MAC 发送一个数据开始信号，MAC 会启动发送；从FIFO中读取数据，向MII接口（RMII/RGMII）发送先导、SFD，发送实际数据；在 DMA控制器向 MAC发送数据结束信号后，MAC加上自动计算的CRC。

MAC 会按照配置自动设备发送帧的类型，并为其中的检验和域计算校验和，并取代原来校验和域的值。此功能可以关闭。

MAC会自动向填充后面加上CRC32校验，也可以设置成不加上 CRC校验位。按照 IEEE802.3协议的规定，数据域长度不低于46字节，当MAC检测到将要发送的数据域短于 46字节时，会自动在数字域后加上填充，如果选择自动填充，则必然会加上 CRC32 校验，无视寄存器配置。MAC 采用的 CRC32检验公式如下：

$$
\operatorname {G} (x) = x ^ {3 2} + x ^ {2 6} + x ^ {2 3} + x ^ {2 2} + x ^ {1 6} + x ^ {1 2} + x ^ {1 1} + x ^ {1 0} + x ^ {8} + x ^ {7} + x ^ {5} + x ^ {4} + x ^ {2} + x + 1
$$

在使能了 IEEE 1588(PTP)功能的情况下，MAC 在发送以太网帧时，将保存当前时间戳在描述符中，但同时会覆盖掉部分信息，用户可以在接收中断中及时读取时间戳并补全描述符。

#### 27.1.5.3 帧接收

以太网收发器在接收以太网帧的时候，以太网帧从MII、RMII 或RGMII 进入到 MAC，在 MAC中首先进入到FIFO，然后被DMA转发到RAM中的缓冲区。MAC 会对以太网帧进行过滤和检查，过滤包括完美地址过滤和HASH过滤，检查则一般是对帧进行帧长度，IP/ICMP/TCP/UDP的检验和 CRC检查，未通过过滤或检查的帧会被描述符标记出来或被丢弃，超过长度的包可能会被掐断。

在使能了IEEE 1588(PTP)功能的情况下，接收帧时，MAC会保存当前时间戳在描述符中，但同时会覆盖掉部分信息，用户可以在接收中断中及时读取时间戳并补全描述符。

#### 27.1.5.4 帧过滤

使用 MAC 帧过滤器可以对接收的帧的目标 MAC 地址和源 MAC 地址进行完美过滤或 HASH 过滤，并可以设置使不通过过滤的帧被丢弃、被接收、或是被在接收描述符中标记出来。此功能请详细阅读 MAC帧过滤寄存器（R32_ETH_MACFFR）的描述。MAC 内置了四个 MAC 地址寄存器，其中 MAC 地址寄存器 0被默认用作存储自身的 MAC 地址，其余三个 MAC 地址寄存器可以被用作完美过滤，与接收到帧的源地址或目标地址对比。在置位 R32_ETH_MACFFR：RA 后，所有接收到的帧都将会被收到，但相应的状态会在之后描述符的第一个字的状态域中被标记出来，如果置位 R32_ETH_MACFFR：PM 会有类似的效果，但是状态不会被标记。在置位R32_ETH_MACFFR：DAIF/SAIF后，会有结果翻转的效果，原来通过过滤的将会被丢弃或标记，未通过过滤的反而会被转给RAM 中的缓冲区。

#### 27.1.5.4.1 单播过滤

MAC 通过 HPF 位和 HU 位来确定单播帧进行 HASH 过滤还是完美地址过滤。

#### 27.1.5.4.2 多播过滤

MAC 通过HPF位和HM位来确定单播帧进行 HASH 过滤还是完美地址过滤。当 PAM位置位后，所有的多播包都能通过过滤器。

#### 27.1.5.4.3 广播过滤

通过置位BFD位，MAC可以阻断所有的广播包。

#### 27.1.5.4.4 源地址过滤选择

通过设置MAC地址寄存器中的AE位,可以启用该 MAC地址寄存器，而设置 SA位可以决定将该 MAC地址寄存器作为源地址样本还是目标地址样本来进行对比。

#### 27.1.5.4.5 小结

对目标地址和源地址的过滤设置分别如表 27-8 和表 27-9。

表 27-8 R32_ETH_MACFFR 各个位的设置对接收到帧的目的 MAC 地址的接受程度  

<table><tr><td>帧类型</td><td>PM</td><td>HPF</td><td>HU</td><td>DAIF</td><td>HM</td><td>PAM</td><td>效果</td></tr><tr><td rowspan="2">广播帧</td><td>1</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>通过</td></tr><tr><td>0</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>不通过(BFD置位)</td></tr><tr><td rowspan="7">单播帧</td><td>1</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>所有帧通过</td></tr><tr><td>0</td><td>-</td><td>0</td><td>0</td><td>-</td><td>-</td><td>完美滤波匹配时通过</td></tr><tr><td>0</td><td>-</td><td>0</td><td>1</td><td>-</td><td>-</td><td>完美滤波匹配时不通过</td></tr><tr><td>0</td><td>0</td><td>1</td><td>0</td><td>-</td><td>-</td><td>HASH滤波匹配时通过</td></tr><tr><td>0</td><td>0</td><td>1</td><td>1</td><td>-</td><td>-</td><td>HASH滤波匹配时不通过</td></tr><tr><td>0</td><td>1</td><td>1</td><td>0</td><td>-</td><td>-</td><td>完美滤波或HASH滤波匹配时通过</td></tr><tr><td>0</td><td>1</td><td>1</td><td>1</td><td>-</td><td>-</td><td>完美滤波或HASH滤波匹配时不通过</td></tr><tr><td rowspan="8">多播帧</td><td>1</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>通过</td></tr><tr><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>1</td><td>通过</td></tr><tr><td>0</td><td>-</td><td>-</td><td>0</td><td>0</td><td>0</td><td>完美滤波匹配时通过</td></tr><tr><td>0</td><td>0</td><td>-</td><td>0</td><td>1</td><td>0</td><td>HASH滤波匹配时通过</td></tr><tr><td>0</td><td>1</td><td>-</td><td>0</td><td>1</td><td>0</td><td>完美滤波或HASH滤波匹配时通过</td></tr><tr><td>0</td><td>-</td><td>-</td><td>1</td><td>0</td><td>0</td><td>完美滤波匹配时不通过</td></tr><tr><td>0</td><td>0</td><td>-</td><td>1</td><td>1</td><td>0</td><td>HASH滤波匹配时不通过</td></tr><tr><td>0</td><td>1</td><td>-</td><td>1</td><td>1</td><td>0</td><td>完美滤波或HASH滤波匹配时不通过</td></tr></table>

表 27-9 R32_ETH_MACFFR 各个位的设置对接收到帧的源 MAC 地址的接受程度  

<table><tr><td>帧类型</td><td>RA</td><td>SAIF</td><td>SAF</td><td>效果</td></tr><tr><td rowspan="5">单播帧</td><td>1</td><td>-</td><td>-</td><td>所有帧通过</td></tr><tr><td>0</td><td>0</td><td>0</td><td>完美过滤器匹配时通过,标记但不丢弃未通过的帧</td></tr><tr><td>0</td><td>1</td><td>0</td><td>完美过滤器匹配时不通过,标记但不丢弃未通过的帧</td></tr><tr><td>0</td><td>0</td><td>1</td><td>完美过滤器匹配时通过,丢弃未通过的帧</td></tr><tr><td>0</td><td>1</td><td>1</td><td>完美过滤器匹配时不通过,丢弃未通过的帧</td></tr></table>

注：“-”表示不关心该位的设置。

#### 27.1.5.5 MMC

管理计数器（MMC）的作用主要是对各种指示帧接收发送状态和 MAC 运转状态进行计数。它可以产生设置并产生中断。一般情况下，我们可以通过接收“好”帧计数器（MMCRGUFCR）获取当前接收到的完好的帧的数量，通过发送“好”帧计数器（MMCTGFCR）来获取成功发送出去的帧的数量，通过接收 CRC 校验错误的帧计数器（MMCRFCECR）查看有无接收 CRC 错误的帧，一般情况下，如果数据时正确的但是 CRC 错误，可以认为 RGMII 线 layout 方面有问题。

用户需要明晰一个概念：什么样的帧是“好”的帧。正常情况下，只要一个帧启动发送，它的帧长符合要求（开启了自动填充），并且开启了自动计算 CRC，那么它就会是一个“好”帧。而一个帧被接收到，只要它CRC正确，帧长在以太网帧长度范围内，帧长和长度域的值一致（如果长度类型域表示的是长度），或没有发生不对齐，那么就会被认为是一个“好”的接收帧。

#### 27.1.5.6 PMT

#### 27.1.5.6.1 概述

PMT（power management）部分的功能主要是通过以太网使微控制器从低功耗模式唤醒。千兆以太网控制器支持两种帧使系统唤醒，即魔法帧和（远程）唤醒帧。当以太网收到这两种帧时，由于微控制器处于低功耗模式，因此并不一定会产生接收中断，即使其合法，但是如果其通过 MAC的魔法帧和唤醒帧识别，就会产生PMT中断，PMT中断是和以太网中断独立的中断，通过查询 PMT控制和状态寄存器就能查出是哪种以太网帧产生了中断。

#### 27.1.5.6.2 魔法帧

AMD 公司定义的魔法帧（magic package，也有称幻数据包）是常用的一种唤醒微控制器的以太网帧，它有固定而特殊的帧格式，即通过帧过滤能让目标网卡接收到，可以封装成广播帧，帧中有连续6个字节的全高（OXFF）,之后紧跟16次重复的目标网卡的 MAC地址。这个组合可以存在于帧的任何位置，因此魔法帧可以封装成 Mac 帧或 IP 包甚至 UDP 包。以下是魔法帧的格式。

xx xx xx xx xx xx xx xx(之前的数据无限制,甚至可以没有之前的数据)—ff ff ff ff ff ff84 c2 e4 01 02 02 84 c2 e4 01 02 02 84 c2 e4 01 02 02 84 c2 e4 01 02 02 84 c2 e4 01 0202 84 c2 e4 01 02 02 84 c2 e4 01 02 02 84 c2 e4 01 02 02 84 c2 e4 01 02 02 84 c2 e4 0102 02 84 c2 e4 01 02 02 84 c2 e4 01 02 02 84 c2 e4 01 02 02 84 c2 e4 01 02 02 84 c2 e401 02 02 84 c2 e4 01 02 02 xx xx xx xx xx xx（有的网卡要求魔法帧最后附带上密码）。

#### 27.1.5.6.3 唤醒帧

由于魔法帧的格式存在限制，（远程）唤醒帧的格式可以由用户自行定义。只要是通过远程唤醒帧过滤寄存器（ETH_MACRWUFFR）组的以太网帧都被认为是唤醒帧，用户通过设置远程唤醒帧过滤寄存器组来定义满足自己需要的唤醒帧。需要注意的是，远程唤醒帧过滤寄存器组只有一个地址入口，用户可以通过连续的八次写操作向其中写数据，再通过连续的八次读数据即可读出原来写进远程唤醒帧过滤寄存器组的数据。

远程唤醒帧过滤寄存器组的结构如下表：

表 27-10 远程唤醒帧过滤寄存器组的结构  

<table><tr><td colspan="8">字节屏蔽寄存器0</td></tr><tr><td colspan="8">字节屏蔽寄存器1</td></tr><tr><td colspan="8">字节屏蔽寄存器2</td></tr><tr><td colspan="8">字节屏蔽寄存器3</td></tr><tr><td>保留</td><td>命令3</td><td>保留</td><td>命令2</td><td>保留</td><td>命令1</td><td>保留</td><td>命令0</td></tr><tr><td colspan="2">偏移3</td><td colspan="2">偏移2</td><td colspan="2">偏移1</td><td colspan="2">偏移0</td></tr><tr><td colspan="4">过滤器1</td><td colspan="4">过滤器0</td></tr><tr><td colspan="4">过滤器3</td><td colspan="4">过滤器2</td></tr></table>

由上表可以看出，字节屏蔽寄存器、命令、偏移好过滤器这四个域共同作用能确定一个帧是否是远程唤醒帧，实际上可以设置四种不同的满足要求的帧。4位命令域的最高位表示对什么样的帧起作用，1为只对多播地址有效，0为只对单播地址有效；命令域的第 2 位和第 1位保留，第 0位为使能位，置高表示启用这组过滤器；偏移域表示从帧头开始偏移多少个字节开始计算 CRC16的值，最小填12，实际生效的值为此域的值加一，如若偏移域为 1，则为从开头第13个字节开始计算CRC16的值，即刚好为网络层的第一个字节开始。32位字节屏蔽表示从偏移域定义的开头开始的 31个字节，哪些需要参与CRC16的计算，字节屏蔽寄存器的最高位必须为 0，最多有 31个字节全部参与计算。而过滤器域则存放了用户期望计算出的 CRC结果的值，MAC会将自己计算出的 CRC16的值与这个域之中的值进行比对，若果一致，则当前帧通过远程唤醒帧过滤器的过滤，被 MAC认定为（远程）唤醒帧，如果使能了唤醒帧中断和 PMT中断，则还会产生 PMT中断。

另外，根据根据PMT控制状态寄存器的位定义，如果置位了 GU位，那么通过帧过滤的单播帧也会被认为是唤醒帧。

#### 27.1.5.7 IEEE1588 PTP

#### 27.1.5.7.1 PTP 原理和实现

IEEE1588 标准定义了一套获取时间的精确协议，它的目标是实现 10 微秒误差之内的时间同步。原本 NTP 协议已经可以实现 200 微秒的级别的时间同步，但实际上这个级别还无法满足工业自动化领

域的时间同步需求，于是网络精密时钟同步委员会起草了 PTP协议，并在 2002 年底被 IEEE标准委员会通过，作为IEEE1588标准。

PTP 协议的实现需要主机和从机都能精确记录 MAC接收和发送以太网帧的时间，这需要主机和从机都有一套自己的高精度时间计数器。随后，支持PTP的主从机通过一套流程进行对时，从机可以以此得到自己和主机的时间差并进行修正。下图显示了主从机对时的流程：

![](images/40c9959d59e8a88982742c9a0ef33bb31a369d53704486629810cc691b3d22e0.jpg)  
图 27-9 IEEE1588 PTP 协议同步报文时序图

分步描述：

主机向从机发送 syn 消息，从机接收到此消息，记录下接收到 syn 消息时的本地时间 t2；  
$\bullet$ 主机向从机发送 follow_up 消息，包含主机发送 syn 消息时的主机时间 t1；  
$\bullet$ 从机向主机发送 delay_req 消息，从机记录下发送时间 t3；  
主机向从机发送 delay_resq 消息，包含 delay_req 消息的接收时间 t4；

实际使用中，主机是每隔两秒对外发一次 syn消息的，而每隔一个 syn消息都可以认为是上个syn消息的follow_up消息，他们都会附带上一次syn 消息的发送时间。从机经过这个过程可以得知主机网络到从机网络延迟时间 Tdelay，然后算出主机时间和从机时间的时间偏移。

$$
\text {T d e l a y} = \frac {(t 2 - t 1) + (t 4 - t 3)}{2}
$$

任一主机发出的时间减去偏移即是主机的时间。

PTP的同步流程一般通过UDP协议实现，当然用户也可以自定协议实现。PTP高度依赖内网的延迟稳定性。

#### 27.1.5.7.2 本地时间更新与校正

为了实现 PTP 的主机，设备本地是需要有一个高精度的时间计数器的，起码要精确到纳秒级。微控制器的千兆以太网计数器的 PTP 模块拥有一个 32 位以秒为单位的计数器，和一个 31 位的亚秒计数器，当亚秒计数器溢出时会引起秒计数器自增，因此本地时间的分辨率可以做到 0.46纳秒左右。

本地时间的更新方式分为两种，即粗调和精调。粗调方式的更新时机是由外部决定的，在需要进行时间更新时，将时间戳控制寄存器的时间更新位（PTPTSCR:TSSTU）置位，微控制器的 PTP 模块会将秒计数器和亚秒计数器减去或加上时间戳更新寄存器（TSHUR、TSLUR）的值。粗调是一种较为简单且方便的时间更新机制，但是精确较差。

精调的时间更新方式是更常用的。其更新流程如下：

![](images/87e6d2bbbd8d4ddb9f7e634defd8b118776c1da6906ec68481273c53b06c406b.jpg)  
图 27-10 使用精调方式更新时间的流程

使用精调模式的方式需要对系统主频和精调的流程有较清晰的了解。与粗调方式不同，精调方式更新事件的时机是累加器（32 位，寄存器列表中未列出。图中的 Accumlator register）溢出，累加器在每个系统主频时钟周期都会自增加数寄存器（PTPTSAR,图中的Addend register）的值，一旦溢出就会产生时间更新事件，即亚秒自增寄存器（PTPSSIR，图中的 Constant Value）的值会加到亚秒计数器（Subsecond register），完成时间更新。在亚秒计数器溢出时，秒计数器会自增。而实际上，亚秒计数器自增一位的时间为 1/(2^31)=0.46566128730…纳秒，用户需要自行保证累加器溢出花费的时间刚好等于亚秒自增寄存器的值乘以亚秒计数器自增一位的时间。

本地时间的校正较为简单，将时间戳控制寄存器的时间校正位（PTPTSCR:TSSTI）置位，则秒计数器和亚秒计数器的值会被时间戳更新计数器（TSHUR、TSLUR）的值替代。

### 27.1.6 DMA 操作

#### 27.1.6.1 概述

在以太网收发器中，数据从MII接口进入 FIFO，然后被 DMA转入 RAM中。即使是最大的普通以太网帧，数据部分达到最大的 1500 字节，也只需要几十微秒左右就能接收发送完毕，即使算上 MAC 的接收检测，DMA 转移时间和帧间隔时间，CPU 也需要在一百微秒内就要处理一个帧。以太网收发器的优势是速度快和吞吐量大，为了维持这个优势，必须把以太网帧接受发送过程中，需要CPU进行的干预尽可能得减少，这里就要使用以太网收发器专用 DMA。

以太网使用的DMA是32位的，它通过两种数据结构接受 CPU的管理：传统的控制和状态寄存器，接收和发送描述符。由于 DMA 是 32 位宽的，所以要求收发描述符队列在 RAM 中的基地址是 4 字节对齐的。收发缓冲区则没有对齐要求。

#### 27.1.6.2 DMA 描述符（DMA Desciptor）

用户使用传统外设主要是通过写寄存器的控制位实现，并且以读取状态寄存器的方式来获取外设的状态和返回信息。这些寄存器是独立于内核，SRAM和非易失性存储器之外的空间，是实际存在的，可以称之为“硬件寄存器”。传统的通讯外设，比如 UART 或SPI，都有一个数据寄存器来暂存收发的数据，有一组DMA将收到的所有数据统一保存到特定的地址空间。

而以太网收发器以其极高的数据传输速度、极大的数据吞吐量和独特的数据帧组织形式，使得它的操作不同于传统的通讯收发器。以太网收发器尽可能密集地接收大量的数据，它必须将收到的数据流以帧为单位存到单独的内存空间，自行完成接收和发送操作，使 CPU能以最少的操作就能读取并处理掉这些数据，释放出对应的内存空间，并保证 DMA控制器和CPU不会就内存的使用权限起冲突。内

存中被开辟用来暂存以太网帧的缓冲区单个大小一般设置为以太网帧的最大包长，IEEE802.3规定为1518个字节（包括源止硬件地址、长度或类型域和CRC32校验域共18个字节）；以太网帧收发缓冲区的数量根据实际交互的频度和微控制器内存资源由用户自行确定。

以太网帧的缓冲区以类似队列的形式组织起来，在接收方向，以太网帧通过 MAC被 DMA写入内存而入队，被 CPU 读取而出队；在发送方向，以太网帧被 CPU 写入内存而入队，被 DMA 读取压入发送FIFO而出队。队列的深度即为缓冲区的个数。和普通的通讯外设不同，以太网帧的缓冲区的起始地址和数量并不是固化在某个寄存器中，而是由一类特殊的数据结构管理，这类数据结构存储在内存中，单个此类数据结构单元管理一个缓冲区，里面保存着缓冲区的起始地址、长度、DMA控制器调用此缓冲区时需要进行的设置、DMA发送完成回写的发送状态以及下一个此类数据结构的地址。这种数据结构起到传统通讯外设控制寄存器、状态寄存器的作用，但是实际位置又在内存中，所以可以称之为“软件寄存器”，正式名称为“DMA 描述符”。

DMA 描述符分发送和接收两种，每种的格式固定。DMA 描述符的存储结构分为两种，一种是链表形式，即每个描述符的第四个字为下一个描述符的地址，DMA控制器会直接从 TDes3/RDes3读取下一个描述符；另一种是环式结构，所有的描述符必须紧密排列，DMA控制从当前描述符结束的位置取下一个描述符，当 DMA 控制器检测到 TDes4/RDes4 的 TER/RER 位置位时，即从描述符列表开头的位置取下一个描述符。描述符数组的地址必须4字节对齐，单个描述符的大小为 16字节。

![](images/af1901e061ca4d4819685a21a9ef47cc7d1f5e5e0dbafb0ad95b23ee190834d6.jpg)  
图27-11分别描述了环式结构和链式结构的一种缓冲区分配方案，供用户分配空间时参考。

#### 27.1.6.2.1 发送 DMA 描述符

表 27-11 表明了发送描述符的结构。

31

0

表 27-11 发送描述符的结构  

<table><tr><td>TDes0</td><td>OWM(31)</td><td colspan="2">CTRL(30:26)</td><td>TTSE(25)</td><td>保留</td><td colspan="2">控制(23:20)</td><td colspan="2">保留(19:18)</td><td>TTSS(17)</td><td>状态(16:0)</td></tr><tr><td>TDes1</td><td colspan="2">保留(31:29)</td><td colspan="4">缓冲区2字节计数(28:16)</td><td colspan="2">保留(15:13)</td><td colspan="3">缓冲区1字节计数(12:0)</td></tr><tr><td>TDes2</td><td colspan="11">缓冲区1地址/时间戳低位</td></tr><tr><td>TDes3</td><td colspan="11">缓冲区2地址/下一个描述符的地址/时间戳高位</td></tr></table>

由上表可以看出发送描述符由四个32位字组成，分别是 TDes0、TDes1、TDes2和 TDes3，其中TDes0用作控制和返回发送状态，TDes1用以指示发送长度，TDes2 用以表示发送缓冲区的位置或返回发送时间戳的低位，TDes3用以表示用于第二个发送缓冲区的地址（TCH未置位时）或下一描述符的地址（TCH置位时），时间戳使能时，发送后返回 IEEE1588 时间戳高位。各 32位字的描述如下。

表 27-12 TDes0 的各位定义  

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23:22</td><td>21</td><td>19</td><td>19:18</td><td>17</td><td>16</td></tr><tr><td>OWN</td><td>IC</td><td>LS</td><td>FS</td><td>DC</td><td>DP</td><td>TTE</td><td>Res</td><td>CIC</td><td>TER</td><td>TCH</td><td>Res</td><td>TSS</td><td>IHE</td></tr></table>

<table><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td>ES</td><td>JT</td><td>FF</td><td>IPE</td><td>LCA</td><td>NC</td><td>LCO</td><td>EC</td><td>VF</td><td colspan="4">CC</td><td>ED</td><td>UF</td><td>DB</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>描述</td></tr><tr><td>31</td><td>OWN</td><td>描述符归属位。此位指示此描述符被谁占用。0:此描述符归CPU所有,CPU可以修改此描述符的值;1:此描述符归DMA所有,CPU无权限修改此描述符。此位为0时,在CPU完成对描述符和缓冲区的操作后,由CPU置1;此位为1时,在DMA完成对描述符和缓冲区的操作后,由DMA自动写0。以此完成用户软件和硬件对描述符和收发缓冲区的操作交接。</td></tr><tr><td>30</td><td>IC</td><td>发送完成中断使能位。置此位后,在发送完当前帧之后,发送中断位标志位(ETH_DMASR:TS)将被置位。</td></tr><tr><td>29</td><td>LS</td><td>末段指示位。此位被置位表示此描述符指示的缓冲区里包含帧的结束部分。</td></tr><tr><td>28</td><td>FS</td><td>首段指示位。此位被置位表示此描述符指示的缓冲区里包含帧的开头部分。</td></tr><tr><td>27</td><td>DC</td><td>禁止自动CRC计算位。置此位后,DMA控制器不会计算以太网帧的CRC32检验值,也不会有值附加到帧末尾。此位只有在FS位被置位时有效。另外,DP位的设置优先级高于此位。</td></tr><tr><td>26</td><td>DP</td><td>禁止自动填充位。置此位后,DMA控制器不会为不足64字节的以太网帧添加自动填充。当此位为0时,DMA会自动为不足64字节的以太网帧添加填充和CRC校验值,忽视DC是否被置位。</td></tr><tr><td>25</td><td>TTE</td><td>时间戳发送使能位。在ETH_PTPTSCR:TSE置位的前提下,置此位后DMA控制器将在当面描述符指示的以太网帧打开IEEE1588时间戳功能。该位仅在FS被置位时有效。</td></tr><tr><td>24</td><td>Reserved</td><td>未使用。</td></tr><tr><td>23:22</td><td>CIC</td><td>校验和和插入控制域。00:禁止插入校验和;01:仅使能IP报头校验和的计算和插入;10:保留;11:使能IP报头校验和和有效负载检验和的计算和插入,使能计算伪报头检验和;</td></tr><tr><td>21</td><td>TER</td><td>发送描述符结束标志设置位。用户对此位置位指示DMA控</td></tr><tr><td></td><td></td><td>制器,当前发送描述符已经是发送描述符数组的最后一个描述符。DMA控制器下次会读取发送描述符数组最前面的一个描述符。</td></tr><tr><td>20</td><td>TCH</td><td>下一描述符地址有效指示位。该位置位表示第二个地址是下一个描述符的地址而不是下一个缓冲区的地址。此位置位时,TBS2域的值不起作用。该位只在FS位置位时有效。TER位的优先级高于此位。</td></tr><tr><td>19:18</td><td>Reserved</td><td>未使用。</td></tr><tr><td>17</td><td>TSS</td><td>发送时间戳捕获状态位。DMA控制器置此位表示,发送时间戳已经捕获到,并存放到TDes2和TDes3中。</td></tr><tr><td>16</td><td>IHE</td><td>IP报头错误状态位。DMA控制器会根据接收到的数据检查IP报头:对于IPv4, DMA控制器会检查报头长度域是否正确;对于IPv6, DMA控制器会检查报头是否为40个字节。另外,IP协议类型必须和以太网帧中类型/长度域一致。</td></tr><tr><td>15</td><td>ES</td><td>错误汇总位。如果发送帧时遇到错误,DMA控制器会置此位。在下列位有一位被置位时,ES位就会被置位:UF[TDES0:1]数据下溢错误位;IPE[TDES0:12]IP数据错误位;FF[TDES0:13]帧清空位;JT[TDES0:14]啰嗦超时位(Jabber timeout);IHE[TDES0:16]IP报头错误位。</td></tr><tr><td>14</td><td>JT</td><td>啰嗦超时位(Jabber timeout)。此位被置位时表示MAC发送端发生了啰嗦超时错误。该位只有在JD位(ETHMACCR:22)没有被置位时才会被置位。</td></tr><tr><td>13</td><td>FF</td><td>帧清空位。此位被置位表示由于CPU发出命令,DMA控制器把帧从FIFO清空。</td></tr><tr><td>12</td><td>IPE</td><td>IP包头错误指示位。MAC会把接收到TCP/UDP/ICMP包的IPv4或IPv6包头中的包总长度和实际包长度做对比,若不一致就会置此位。</td></tr><tr><td>11</td><td>LCA</td><td>载波丢失指示位。此位置位表示帧在发送时发生了载波丢失,即CSR信号存在无效状态。该位只在半工模式下起作用。</td></tr><tr><td>10</td><td>NC</td><td>无载波指示位。该位表示帧在发送时物理层的载波侦听信号无效。该位只在半工模式下起作用。</td></tr><tr><td>9</td><td>LCO</td><td>迟到冲突指示位。该位表示帧在发送完前导符之后出现冲突。该位只在半工模式下起作用。</td></tr><tr><td>8</td><td>EC</td><td>冲突过多指示位。该位表示帧发送时出现了16位以上的冲突。如果MACCR的RD位置位,该位表示只发送了一次冲突。该位只在半工模式下起作用。</td></tr><tr><td>7</td><td>VF</td><td>VLAN位。在发送VLAN帧时,此位会被置位。</td></tr><tr><td>6:3</td><td>CC</td><td>冲突计数器域。此域表示帧在发送时发生了多少次冲突。EC置位时无效。该域只在半工模式下起作用。</td></tr><tr><td>2</td><td>EC</td><td>顺延过多指示位。此位置位表示在MACCR的DC置位时,发送帧因为顺延超过24288位而导致发送失败。该位只在半工模式下起作用。</td></tr><tr><td>1</td><td>UF</td><td>UF数据下溢错误位。当DMA控制器发送时从指定的RAM取</td></tr><tr><td></td><td></td><td>数据发现缓冲区为空时，发送进入暂停状态，并置该位和DMASR寄存器的相关位。</td></tr><tr><td>0</td><td>DB</td><td>顺延指示位。此位置位表示发送过程由于载波占用而失败。该位只在半工模式下起作用。</td></tr></table>

表 27-13 TDes1 的各位定义  

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="3">Reserved</td><td colspan="13">TBS2</td></tr></table>

<table><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="3">Reserved</td><td colspan="13">TBS1</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>描述</td></tr><tr><td>31:29</td><td>Reserved</td><td>未使用。</td></tr><tr><td>28:16</td><td>TBS2</td><td>发送缓冲区2的大小。</td></tr><tr><td>15:13</td><td>Reserved</td><td>未使用。</td></tr><tr><td>12:0</td><td>TBS1</td><td>发送缓冲区1的大小。</td></tr></table>

表 27-14 TDes2 的各位定义  

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TBAD1/TTSL</td></tr></table>

<table><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TBAD1/TTSL</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>描述</td></tr><tr><td>31:0</td><td>TBAD1/TTSL</td><td>TDes2 全部 32 位作为一整个单元用来存放发送缓冲区 1 的地址。在启用 IEEE1588 模式中,在完成发送之后,TDes2 也用来存放 MAC 返回的时间戳,同时 MAC 会把 OWN 位 (TDes0:31) 清零。此域存放时间戳的低 32 位。</td></tr></table>

表 27-15 TDes3 的各位定义  

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>20</td><td>17</td><td>16</td></tr><tr><td colspan="16">TDAD2/TTSH</td></tr></table>

<table><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TDAD2/TTSH</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>描述</td></tr><tr><td>31:0</td><td>TDAD2/TTSH</td><td>此域用来存放下一个描述符的地址，在TCH未置位时，此域存放发送缓冲区2的地址。在启用IEEE1588模式中，在完成发送之后，TDes3用来存放MAC返回的时间戳，同时MAC会把OWN位(TDes0:31)清零。此域存放时间戳的高32位。</td></tr></table>

#### 27.1.6.2.2 接收 DMA 描述符

31

0

表 27-16 接收描述符的结构  

<table><tr><td>RDes0</td><td>OWM(31)</td><td colspan="5">状态(30:0)</td></tr><tr><td>RDes1</td><td>控制(31)</td><td>保留(30:29)</td><td>缓冲区2字节计数(28:16)</td><td>RER(15:14)</td><td>保留13</td><td>缓冲区1字节计数(12:0)</td></tr><tr><td>RDes2</td><td colspan="6">缓冲区1地址、时间戳低位</td></tr><tr><td>RDes3</td><td colspan="6">缓冲区2地址、下一个描述符的地址、时间戳高位</td></tr></table>

由上图可以看出接收描述符也是由四个 32位字组成的，其中第一个 32位字主要是返回接收时的状态，第二个32位字包含了接收的数据长度，第三个 32位字定义了接收缓冲区的地址或者返回时间戳的低位，第四个 32 位字做第二个缓冲区的地址（RCH 未置位）,下一缓冲区的地址（RCH 置位）或返回时间戳的高位。

接收描述符各字的各位意义如下：

表 27-17 RDes0 的各位定义  

<table><tr><td>31</td><td>30</td><td>29:16</td></tr><tr><td>OWN</td><td>AFM</td><td>FL</td></tr></table>

<table><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td>ES</td><td>DE</td><td>SAF</td><td>LE</td><td>OE</td><td>VLAN</td><td>FS</td><td>LS</td><td>IPHCE</td><td>LCO</td><td>PT</td><td>RWT</td><td>RE</td><td>DE</td><td>CE</td><td>PCE</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>描述</td></tr><tr><td>31</td><td>OWN</td><td>描述符归属位。此位指示此描述符被谁占用。0:此描述符归CPU所有,CPU可以修改此描述符的值;1:此描述符归DMA所有,CPU无权限修改此描述符。此位为0时,在CPU完成对描述符和缓冲区的操作后,由CPU置1;此位为1时,在DMA完成对描述符和缓冲区的操作后,由DMA自动写0。以此完成用户软件和硬件对描述符和收发缓冲区的操作交接。</td></tr><tr><td>30</td><td>AFM</td><td>目标地址未通过标志位。如果接收的帧未通过MAC的目标地址过滤器,那么此标志位会被置位。</td></tr><tr><td>29:16</td><td>FL</td><td>帧长域。此域在ES位[RDes0:15]为0时有效。在LS位[RDes0:8]为1时,此域指示了DMA控制器接收到的帧的长度,包括CRC;在LS位为0时,此域表示目前为止DMA控制器发往内存的累计长度,单位都是字节。</td></tr><tr><td>15</td><td>ES</td><td>错误汇总位。当MAC检测到以下任一错误时,会置位此位:CE[RDes0:1]:CRC错误;RE[RDes0:3]:接收错误;RWT[RDes0:4]:看门狗超时;</td></tr><tr><td></td><td></td><td>IPHCE[RDes0:7]:巨型帧(注意,报 IPHCE 时需要分辨到底是巨型帧还是由 IP 头错误);OE[RDes0:11]:溢出错误;DE[RDes0:14]:描述符错误。</td></tr><tr><td>14</td><td>DE</td><td>描述符错误位。该位被置位表示由于描述符指示的缓冲区装不上当前帧而被切断,DMA 又不占用下一描述符。该位只在 LS 位[RDes0:8]被置位时才有效。</td></tr><tr><td>13</td><td>SAF</td><td>源地址过滤未通过标志位。此位被置位表示帧没有通过MAC 的源地址过滤器。</td></tr><tr><td>12</td><td>LE</td><td>长度错误位。此位被置位表示实际收到的帧长度和以太网类型/长度域中指示的长度不符合。此位只在 FT[RDes0:5]被置位时有效。</td></tr><tr><td>11</td><td>OE</td><td>溢出错误位。此位被置位表示由于接收 FIFO 溢出,接收到的帧被破坏。</td></tr><tr><td>10</td><td>VLAN</td><td>VLAN 标签位。该位被置位表示接收到的是 VLAN 帧。</td></tr><tr><td>9</td><td>FS</td><td>首描述符指示位。该位置位表示这个描述符包含帧的开头。</td></tr><tr><td>8</td><td>LS</td><td>尾描述符指示位。该位置位表示这个描述符包含帧的结尾。</td></tr><tr><td>7</td><td>IPHCE</td><td>IP 报头校验和错误标志位。该位置位表示 IPv4 或者 IPv6 报头存在错误,具体原因可能是:1、以太网帧类型/长度域指示的协议与实际的 IP 版本不一致;2、IP 报头校验和不对;3、IP 报头指示的长度不对。</td></tr><tr><td>6</td><td>LCO</td><td>迟到冲突指示位。该位置位表示产生了迟到冲突。该位只在半双工模式下起作用。</td></tr><tr><td>5</td><td>FT</td><td>帧类型指示位。此位为 1 时表示接收到的帧为以太网类型封装的帧(RFC 894)。此位为 0 时表示接收到的帧为IEEE802.3 类型封装的帧(RFC1042)。当帧长度小于 14 字节时,此位无效。注:FT 具有的特殊含义参考表 27-18</td></tr><tr><td>4</td><td>RWT</td><td>接收看门狗超时标志位。该位置位表示在接收当前帧时,看门狗超时,当前帧被截断。</td></tr><tr><td>3</td><td>RE</td><td>接收错误标志位。该位置位表示在接收帧的过程中,RX_DV有效时,RX_ERR 信号有效。</td></tr><tr><td>2</td><td>DE</td><td>Dribble 比特错误位。该位置位表示 MAC 接收到的帧的长度不是 8bit 的帧数倍,可能有漏掉周期的现象。</td></tr><tr><td>1</td><td>CE</td><td>CRC 错误。该位置位表示接收到的帧存在 CRC 校验错误。该位只在 LS 位[RDes0:8]置位时有效。</td></tr><tr><td>0</td><td>PCE</td><td>负载校验和错误。该位置位表示 MAC 接收到的TCP/UDP/ICMP 包与其校验和域标示的值不符。</td></tr></table>

可以看出 MAC 的接收流程中做了校验检验机制。实际上在以太网帧层（数据链路层）、网络层（IPv4/IPv6）和运输层（TCP/UDP/SCTP）都有对本层数据长度进行说明，对数据内容正确性采取某种手段的校验。RDES0 的第 0、5 和 7 位都提到了对数据的校验检验，下表进行归纳。

表 27-18 RDES:7/5/0 的值和接收到的帧状态的关系  

<table><tr><td>RDESO:7</td><td>RDESO:5</td><td>RDESO:0</td><td rowspan="2">帧状态</td></tr><tr><td>IPHCE</td><td>FT</td><td>PCE</td></tr><tr><td>1</td><td>1</td><td>1</td><td>为IP帧，IP层和运输层存在校验错误。</td></tr><tr><td>1</td><td>1</td><td>0</td><td>为IP帧，IP层存在校验错误。</td></tr><tr><td>1</td><td>0</td><td>1</td><td>为IP帧，运输层存在校验错误。</td></tr><tr><td>1</td><td>0</td><td>0</td><td>为IP帧，未检测到校验和错误。</td></tr><tr><td>0</td><td>1</td><td>1</td><td>非IP帧，未执行检验检测。</td></tr><tr><td>0</td><td>1</td><td>0</td><td>保留。</td></tr><tr><td>0</td><td>0</td><td>1</td><td>为IP帧，不支持的运输层协议，未检测到IP层校验和错误。</td></tr><tr><td>0</td><td>0</td><td>0</td><td>长度/类型域小于0x0600的帧。</td></tr></table>

表 27-19 RDes1 的各位定义  

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>DIC</td><td colspan="2">Reserved</td><td colspan="13">RBS2</td></tr></table>

<table><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td>RER</td><td>RCH</td><td>Res</td><td colspan="13">RBS1</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>描述</td></tr><tr><td>31</td><td>DIC</td><td>关闭接收完成中断设置位。</td></tr><tr><td>30:29</td><td>Reserved</td><td>未使用。</td></tr><tr><td>28:16</td><td>RBS2</td><td>接收缓冲区2大小。</td></tr><tr><td>15</td><td>RER</td><td>末端接收描述符标志。指示当前描述符是最后一个描述符。DMA控制器会回到描述符对列基地址寄存器(ETH_DMARDLAR)去取下一个描述符。</td></tr><tr><td>14</td><td>RCH</td><td>下一接收描述符地址有效位。该位置位表示最后一个32位字中是下一个接收描述符的地址,否则则是第2个缓冲区的地址。</td></tr><tr><td>13</td><td>Reserved</td><td>未使用。</td></tr><tr><td>12:0</td><td>RBS1</td><td>接收缓冲区1大小。</td></tr></table>

表 27-20 RDes2 的各位定义  

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">RBAD1/RTSL</td></tr></table>

<table><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">RBAD1/RTSL</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>描述</td></tr><tr><td>31:0</td><td>RBAD/RTSL</td><td>RDes2 全部 32 位作为一整个单元用来存放接收缓冲区的地址。在启用 IEEE1588 模式中，在完成接收之后，RDes2</td></tr><tr><td></td><td></td><td>也用来存放 MAC 返回的时间戳，同时 MAC 会把 OWN 位 [RDes0:31]清零。</td></tr></table>

表 27-21 RDes3 的各位定义  

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">RDAD2/RTSH</td></tr></table>

<table><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">RDAD2/RTSH</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>描述</td></tr><tr><td>31:0</td><td>RDAD/RTSH</td><td>RCR 置位时用来存放下一个缓冲区的地址，否则用来存在第二个缓冲区的地址。在启用 IEEE1588 模式中，在完成接收之后，RDes3 用来存放 MAC 返回的时间戳，同时 MAC 会把 OWN 位 [RDes0:31] 清零。此域存放时间戳的高 32 位。</td></tr></table>

#### 27.1.6.3 数据缓存对齐

由于收发缓冲区和收发描述符都是由 DMA 控制器调用，并实质存在于 RAM 空间的，而 DMA 是 32位的，因此设置收发描述符队列都需要保证它们的起始地址在4 字节对齐的位置，但是设置缓冲区没有这个强制要求。

为了提高效率，一个以太网帧由一个缓冲区接收完毕是最恰当的，如将缓冲区设为 1518 个字节可以容纳下最大的以太网普通帧，包括源止地址域、长度类型域、数据填充域和 CRC校验域。需要注意的是，带标签的VLAN帧的最大帧长比一般的以太网帧长 4个字节，即 1522个字节，如果用户想做到4字节对齐，一个缓冲区可以为1524字节。

#### 27.1.6.4 DMA 收发配置

接收和发送的数据由DMA负责自动转存和推送，但是如果遇到致命错误，DMA会停止运转，并更新DMA状态寄存器。用户用需要初始化DMA后手动启动 DMA才能继续运转。

#### 27.1.6.4.1 发送 DMA 配置

DMA 控制器建立运转机制的步骤如下：

1） 设置发送缓冲区队列，将要发送的内容填入发送缓冲区。设置发送描述符队列，填好发送描述符的各域各位，并将OWN置位，将发送描述符的管理权交付给 DMA控制器；将描述符初始地址注册到 DMATDLAR 寄存器中；  
2） 置位 ST 位（DMAOMR:13），开启 DMA；  
3） 在运行模式下，DMA描述符会自动读取发送描述符的内容，根据其指示的地址和长度把数据推送到发送 FIFO。结束后 DMA 会按照链式结构读取紧接着的下一个发送描述符进行下一次发送。当DMA 控制器检测到 OWM 位未置位导致无权访问发送描述符或者其他正常的错误，就会终止传输，并将 TBUS 位（DMASR:2）或其他位（非 OWN 为 0 引起的错误）和 NIS 位（DMASR:16）置位。  
4） 不允许单个帧跨越多个描述符，一帧必须由一个描述符和一个缓冲区关联清楚。  
5） 如果 MAC 开启了 IEEE1588 PTP 模式，那么在 DMA 控制器把数据推送到 FIFO 之后，MAC 会把发送时间戳写到 TDes2 和 TDes3 中，并复位 OWN 位。  
6） 在发送完一个帧之后，如果发送描述符使能了发送完成中断（置位 TDes1:31），DMA 控制器就会置位发送完成中断标志位（DMASR:0），然后继续取下一个发送描述符。下图展示了默认发送流程。

![](images/276a3bdba27a09dd4d09151b01d16703b9b91dc89c5e2991145b24ec05cc8bb6.jpg)  
图 27-11 发送流程

#### 27.1.6.4.2 接收 DMA 配置

建立 DMA 接收流转机制的步骤如下：

1） 设置发送缓冲区队列和描述符队列，设置好接收描述符的各个域各个位；将描述符初始地址注册到DMARDLAR寄存器中；置位OWN位，将描述符使用权限交给 DMA控制器；  
2） 置位 SR 位，开始接收流程；  
3） 在接收流转机制运行时，DMA控制器获取下一个描述符，检查接收描述符配置，在 FIFO 接收到下一帧时，对帧内容进行过滤和识别等多项检查，将帧数据转发描述符指定的缓冲区中，写描述符状态域并获取下一个接收描述符，报接收完成中断。如果帧未通过过滤会被标记或丢弃，如果帧存在检验和错误、CRC错误或帧过短将会被标记，如果帧过长可能会被掐断或报接收看门狗超时错误。DMA 控制器遇到接收描述符不可用等致命错误将会停止接收流程，用户需要特别留意；  
4） 用户至少需要使能一个接收完成中断，在以太网中断函数中将使用过的接收描述符恢复到待命状态，以保证接收流程可以不间断地运行下去。用户可以在中断函数中将待处理的数据缓冲区地址传递出来，或处理一些打断接收流程的异常事件。  
5） 如果使能了 PTP 时间戳，再 DMA 控制器转存数据，写描述符状态域时，同时也会将当前的时间戳写进描述符的后两个字。用户应及时将时间戳读出并补全原写在后两个字的缓冲区地址和下一描述符地址。

下图展示了默认接收流转机制：

![](images/a7520b2d805d6cfbad9827222c288090fa063107043848d346c32effab121235.jpg)  
图 27-12 接收流程

### 27.1.7 中断

以太网收发器拥有两个中断向量，一个是以太网唤醒事件，另一个是普通的收发事件。当检测到唤醒帧或魔法帧的时候，会触发以太网唤醒事件。普通的以太网收发中断事件包括 DMA中断和ETH 中断。

#### 27.1.7.1 DMA 中断

DMA 中断大致可以分为两组，即正常的中断（NIS）和异常的中断（AIS），异常的中断一般意味着数据收发的异常，需要特别注意。用户在处理中断时需要检索所有的中断标志位，并将已经产生的中断源全部处理掉。下图是以太网收发器的中断示意图。

![](images/d234f8e1e0276be819a45137baccdf2a9edb33c534093201cdc2194196620246.jpg)  
图 27-13 中断示意图

DMA中断是以太网收发器中最重要的中断，一般的用户逻辑中都需要依靠中断接收帧，确认帧发送出去，或是及时处理被打断的收发逻辑。

#### 27.1.7.2 ETH 中断

ETH 中断主要包括 PTP 的时间闹钟触发，收发计数到了 MMC 寄存器的某种设定值，以及 PMT。ETH的用处主要是功能性的，相对 DMA 中断而言并不十分复杂和重要。用户可以使用 PTP 中断实现闹钟，使用MMC中断实现测速，或使用PMT中断实现远程唤醒。另外，ETH还支持当内置物理层连接状态发生改变时产生中断。

#### 27.1.7.3 PMT 中断

将PMT中断单独提出来重述一遍的原因是这个中断拥有独立的中断向量，使用时需注意。

## 27.1.8 寄存器描述

表27-22 以太网收发器相关寄存器列表  
MAC控制相关寄存器地址映射   

<table><tr><td>名称</td><td>偏移地址</td><td>描述</td><td>复位值</td></tr><tr><td>R32 ETH MACCR</td><td>0x40028000</td><td>MAC 控制寄存器</td><td>0x00008000</td></tr><tr><td>R32 ETH MACFFR</td><td>0x40028004</td><td>帧过滤寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH MACHTHR</td><td>0x40028008</td><td>哈希值列表寄存器高位</td><td>0x00000000</td></tr><tr><td>R32 ETH MACHTLR</td><td>0x4002800C</td><td>哈希值列表寄存器低位</td><td>0x00000000</td></tr><tr><td>R32 ETH MACMI IAR</td><td>0x40028010</td><td>MII 地址寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH MACMI IDR</td><td>0x40028014</td><td>MII 数据寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH MACFCR</td><td>0x40028018</td><td>MAC 流控寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH MACVLAN</td><td>0x4002801C</td><td>VLAN 标签寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH MACRWUFFR</td><td>0x40028028</td><td>唤醒帧过滤器寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH MACPMTCSR</td><td>0x4002802C</td><td>PMT 控制和状态寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH MACSR</td><td>0x40028038</td><td>MAC 中断状态寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH MACIMR</td><td>0x4002803C</td><td>MAC 中断屏蔽寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH MACAOHR</td><td>0x40028040</td><td>MAC 地址 0 寄存器高位</td><td>0x0010FFFF</td></tr><tr><td>R32 ETH MACAOLR</td><td>0x40028044</td><td>MAC 地址 0 寄存器低位</td><td>0xFFFFFF</td></tr><tr><td>R32 ETH_MACA1HR</td><td>0x40028048</td><td>MAC 地址 1 寄存器高位</td><td>0x0000FFF</td></tr><tr><td>R32 ETH_MACA1LR</td><td>0x4002804C</td><td>MAC 地址 1 寄存器低位</td><td>0xFFFFFFFFF</td></tr><tr><td>R32 ETH_MACA2HR</td><td>0x40028050</td><td>MAC 地址 2 寄存器高位</td><td>0x0000FFF</td></tr><tr><td>R32 ETH_MACA2LR</td><td>0x40028054</td><td>MAC 地址 2 寄存器低位</td><td>0xFFFFFFFFF</td></tr><tr><td>R32 ETH_MACA3HR</td><td>0x40028058</td><td>MAC 地址 3 寄存器高位</td><td>0x0000FFF</td></tr><tr><td>R32 ETH_MACA3LR</td><td>0x4002805C</td><td>MAC 地址 3 寄存器低位</td><td>0xFFFFFFFFF</td></tr></table>

MMC 控制相关寄存器地址映射，注意：地址非连续  

<table><tr><td>名称</td><td>偏移地址</td><td>描述</td><td>复位值</td></tr><tr><td>R32 ETH_MMCCR</td><td>0x40028100</td><td>MMC 控制寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMCRIR</td><td>0x40028104</td><td>MMC 接收寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMCTIR</td><td>0x40028108</td><td>MMC 发送中断寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMCRIMR</td><td>0x4002810C</td><td>MMC 接收中断屏蔽寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMCTIMR</td><td>0x40028110</td><td>MMC 发送中断屏蔽寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMCTGFSCCR</td><td>0x4002814C</td><td>MMC 一次冲突发送好帧计数器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMCTGFMSCCR</td><td>0x40028150</td><td>MMC 多次冲突发送好帧计数器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMCTGFCR</td><td>0x40028168</td><td>MMC 发送好帧计数寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMRCRFCER</td><td>0x40028194</td><td>MMC 存在 CRC 检验错误的帧接收计数寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMRCFAECR</td><td>0x40028198</td><td>接收对齐错误帧计数器</td><td>0x00000000</td></tr><tr><td>R32 ETH_MMRCGUFCR</td><td>0x400281C4</td><td>MMC 接收奢单播帧计数寄存器</td><td>0x00000000</td></tr></table>

IEEE1588（PTP）相关寄存器地址映射   

<table><tr><td>名称</td><td>偏移地址</td><td>描述</td><td>复位值</td></tr><tr><td>R32 ETH PTPTSCR</td><td>0x40028700</td><td>PTP时间戳控制寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH PTPSSIR</td><td>0x40028704</td><td>PTP亚秒递增寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH PTPTSHR</td><td>0x40028708</td><td>PTP时间戳寄存器高位</td><td>0x00000000</td></tr><tr><td>R32 ETH PTPTSLR</td><td>0x4002870C</td><td>PTP时间戳寄存器低位</td><td>0x00000000</td></tr><tr><td>R32 ETH PTPTSHUR</td><td>0x40028710</td><td>PTP时间戳更新寄存器高位</td><td>0x00000000</td></tr><tr><td>R32 ETH PTPTSLUR</td><td>0x40028714</td><td>PTP时间戳更新寄存器低位</td><td>0x00000000</td></tr><tr><td>R32 ETH PTPTSAR</td><td>0x40028718</td><td>PTP时间戳加数寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH PTPTTHR</td><td>0x4002871C</td><td>PTP目标寄存器高位</td><td>0x00000000</td></tr><tr><td>R32 ETH PTPTTLR</td><td>0x40028720</td><td>PTP目标寄存器低位</td><td>0x00000000</td></tr></table>

DMA 相关寄存器地址映射注意：地址非连续  

<table><tr><td>名称</td><td>偏移地址</td><td>描述</td><td>复位值</td></tr><tr><td>R32 ETH_DMABMR</td><td>0x40029000</td><td>DMA总线模式寄存器</td><td>0x00002101</td></tr><tr><td>R32 ETH_DMATPDR</td><td>0x40029004</td><td>DMA发送查询寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMARPDR</td><td>0x40029008</td><td>DMA接收查询寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMARDLAR</td><td>0x4002900C</td><td>DMA接收描述符地址寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMATDLAR</td><td>0x40029010</td><td>DMA发送描述符地址寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMASR</td><td>0x40029014</td><td>DMA状态寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMAOMR</td><td>0x40029018</td><td>DMA操作模式寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMAIER</td><td>0x4002901C</td><td>DMA中断使能寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMAMFBOCR</td><td>0x40029020</td><td>DMA 丢失帧寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMACHTDR</td><td>0x40029048</td><td>DMA 当前发送描述符寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMACHRDR</td><td>0x4002904C</td><td>DMA 当前接收描述符寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMACHTBAR</td><td>0x40029050</td><td>DMA 当前发送缓存寄存器</td><td>0x00000000</td></tr><tr><td>R32 ETH DMACHRBAR</td><td>0x40029054</td><td>DMA 当前接收缓存寄存器</td><td>0x00000000</td></tr></table>

内部 10M 物理层相关寄存器地址  

<table><tr><td>名称</td><td>偏移地址</td><td>描述</td><td>复位值</td></tr><tr><td>BMCR</td><td>0x00</td><td>基本控制寄存器</td><td>0x2100</td></tr><tr><td>BMSR</td><td>0x01</td><td>基本状态寄存器</td><td>0x1809</td></tr><tr><td>PHY_SR</td><td>0x10</td><td>物理层状态寄存器</td><td>0x0000</td></tr><tr><td>PHY_MDIX</td><td>0x1E</td><td>自动翻转寄存器</td><td>0x0000</td></tr></table>

注：内部物理层寄存器的偏移地址在SMI接口中使用

### 27.1.8.1 MAC 控制相关寄存器各位域

#### 27.1.8.1.1 MAC 控制寄存器（R32_ETH_MACCR）

偏移地址： $0 \times 0 0$   

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="3">TCD</td><td colspan="5">Reserved</td><td>WD</td><td>JD</td><td>PI</td><td>PR</td><td colspan="3">IFG</td><td>Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td>FES</td><td>Reserved</td><td>LM</td><td>DM</td><td>IPCO</td><td colspan="2">Reserved</td><td>APCS</td><td colspan="4">Reserved</td><td>TE</td><td>RE</td><td>TCF</td><td>Reserved</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:29]</td><td>TCD</td><td>RW</td><td>发送时钟延迟域。此域用来延迟发送时钟。MAC控制器把经过CES位(ETH_MACCR[1])选择的发送时钟进行延时输出。延时时间计算公式:Tdaleny=TCD(ETH_MACCR[31:29])*0.5ns;</td><td>0</td></tr><tr><td>[28:24]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>23</td><td>WD</td><td>RW</td><td>看门狗设置位。0:MAC打开看门狗,只能接受最大2048字节的以太网帧,超长部分会被切断;1:MAC关闭开门狗,能接收最大16384个字节的以太网帧;</td><td>0</td></tr><tr><td>22</td><td>JD</td><td>RW</td><td>Jabber设置位。0:如果用户试图发送超过2048字节以上长度的以太网帧,MAC会关闭发送器;1:MAC关闭Jabber定时器,最多能发送16384字节的以太网帧;</td><td>0</td></tr><tr><td>21</td><td>PI</td><td>RW</td><td>内置10MPHY发送驱动偏置电流设置位。0:额定驱动;1:节能发送;</td><td>0</td></tr><tr><td>20</td><td>PR</td><td>RW</td><td>内置10MPHY片内50欧电阻上拉开启设置位。0:片内50欧电阻断开;1:片内50欧电阻连接;</td><td>0</td></tr><tr><td>[19:17]</td><td>IFG</td><td>RW</td><td>帧间隙设置域。这里设置了发送两个帧之间的最短时间间隙。000:96位时间;001:88位时间;010:80位时间;011:72位时间;100:64位时间;101:56位时间;110:48位时间;111:40位时间。</td><td>000b</td></tr><tr><td>16</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>[15:14]</td><td>FES</td><td>RW</td><td>以太网速度设置域。00:10Mbit/s;01:100Mbit/s;10:1Gbit/s;11:保留,未使用。</td><td>00b</td></tr><tr><td>13</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>12</td><td>LM</td><td>RW</td><td>自循环模式使能位。置该位使能自循环模式。</td><td>0</td></tr><tr><td>11</td><td>DM</td><td>RW</td><td>双工模式使能位。置该位使能全双工模式。</td><td>0</td></tr><tr><td>10</td><td>IPCO</td><td>RW</td><td>IPv4校验检验使能位。0:关闭接收端IPv4的校验和检验功能,相应的PCE、PHCE标志位总是为0。见接收描述符各位定义;1:使能IPv4的校验检验,MAC控制器会对TCP、UDP和ICMP报头进行校验和检验。</td><td>0</td></tr><tr><td>[9:8]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>7</td><td>APCS</td><td>RW</td><td>填充&amp;CRC自动剥离使能位。0:MAC不改变帧的内容;1:在接收长度小于等于1500字节的以太网帧时,MAC自动去除帧的填充字节和CRC域;在大于1500字节的以太网帧中,MAC不做更改。</td><td>0</td></tr><tr><td>[6:4]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>3</td><td>TE</td><td>RW</td><td>发送使能位。0:MAC在发送完当前帧之后,关闭发送器,不再发送任何帧;1:使能MAC发送器。</td><td>0</td></tr><tr><td>2</td><td>RE</td><td>RW</td><td>接收使能位。0:MAC在接收完当前帧之后,关闭接收器,不再接收任何帧;1:使能MAC接收器。</td><td>0</td></tr><tr><td>1</td><td>TCF</td><td>RW</td><td>发送时钟翻转设置位。0:将TCEs选择的TXC直接作为芯片输出的GTX_CLK;</td><td>0</td></tr><tr><td></td><td></td><td></td><td>1:将 TCES 选择的 TXC 的反相作为芯片输出的 GTX_CLK。</td><td></td></tr><tr><td>0</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr></table>

#### 27.1.8.1.2 MAC 帧过滤寄存器（R32_ETH_MACFFR）

偏移地址： $0 \times 0 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>RA</td><td colspan="15">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="4">Reserved</td><td>HPF</td><td>SAF</td><td>SAIF</td><td colspan="2">PCF</td><td>BFD</td><td>PAM</td><td>DAIF</td><td>HM</td><td>HU</td><td colspan="2">PM</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>RA</td><td>RW</td><td>接收全部位。0:MAC只把通过了过滤器的帧转发到接收队列中;1:MAC把所有收到的帧转发到接收队列中,不管其是否通过了过滤器。</td><td>0</td></tr><tr><td>[30:11]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>10</td><td>HPF</td><td>RW</td><td>HASH过滤或者完美过滤选择位。0:在HM或者HU置位的前提下,只要符合HASH过滤器,就能通过地址过滤;1:根据HM或者HU的值来确定单播/多播模式下使用什么过滤方式。</td><td>0</td></tr><tr><td>9</td><td>SAF</td><td>RW</td><td>源地址过滤选择位。0:MAC对未通过源MAC地址过滤的帧进行标记;1:MAC会直接丢弃未通过源MAC地址过滤的帧;</td><td>0</td></tr><tr><td>8</td><td>SAIF</td><td>RW</td><td>源地址过滤结果颠倒位。0:接收的帧的源地址如果和MAC地址寄存器中启用的源地址不一致则认为是未通过源地址过滤器;1:接收的帧的源地址如果和MAC地址寄存器中启用的源地址一致则认为是未通过源地址过滤器;</td><td>0</td></tr><tr><td>[7:6]</td><td>PCF</td><td>RW</td><td>流控帧通过控制域。00/01:MAC不转发任何流控帧给应用程序;10:MAC转发所有流控帧到应用程序中,包括未通过地址过滤器的流控帧;11:MAC只转发通过地址过滤器的流控帧;</td><td>00b</td></tr><tr><td>5</td><td>BFD</td><td>RW</td><td>广播帧接收控制位。0:接收所有广播帧;1:丢弃所有广播帧;</td><td>0</td></tr><tr><td>4</td><td>PAM</td><td>RW</td><td>通过全部多播帧控制位。0:多播帧能否通过过滤取决于HM的值;1:全部的多播帧都能通过地址过滤;</td><td>0</td></tr><tr><td>3</td><td>DAIF</td><td>RW</td><td>目的MAC地址过滤器过滤结果颠倒控制位。0:过滤器结果正常生效;1:对多播帧和单播帧,是否过滤器通过的结果进行</td><td>0</td></tr><tr><td></td><td></td><td></td><td>颠倒再生效;</td><td></td></tr><tr><td>2</td><td>HM</td><td>RW</td><td>多播帧过滤模式选择位。
0:进行完美地址过滤;
1:进行 HASH 地址过滤;</td><td>0</td></tr><tr><td>1</td><td>HU</td><td>RW</td><td>单播帧过滤模式选择位。
0:进行完美地址过滤;
1:进行 HASH 地址过滤;</td><td>0</td></tr><tr><td>0</td><td>PM</td><td>RW</td><td>混杂模式使能位。所有帧都能通过地址过滤器,且不标记过滤结果。</td><td>0</td></tr></table>

#### 27.1.8.1.3 哈希值列表寄存器（R32_ETH_MACHTHR、R32_ETH_MACHTLR）

偏移地址： $0 \times 0 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">HTH</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">HTH</td></tr></table>

偏移地址： $0 \times 0 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">HTL</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">HTL</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>HTH</td><td>RW</td><td>哈希列表高32位</td><td>00000000h</td></tr><tr><td>[31:0]</td><td>HTL</td><td>RW</td><td>哈希列表低32位</td><td>00000000h</td></tr></table>

#### 27.1.8.1.4 MII 地址寄存器（R32_ETH_MACMIIAR）

偏移地址：0x10

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="5">PA</td><td colspan="5">MR</td><td>Res</td><td colspan="3">CR</td><td>MW</td><td>MB</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:16]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[15:11]</td><td>PA</td><td>RW</td><td>物理层地址域。用户将需要操作的物理层地址写进此域。</td><td>0</td></tr><tr><td>[10:6]</td><td>MR</td><td>RW</td><td>物理层寄存器地址域。用户将需要操作的寄存器地址写进此域。</td><td>0</td></tr><tr><td>5</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[4:2]</td><td>CR</td><td>RW</td><td>时钟范围设定域。用户请保持为000b,使MII频率为主频的42分频。</td><td>0</td></tr><tr><td>1</td><td>MW</td><td>RW</td><td>读写设定位。0:对物理层进行读操作;1:对物理层进行写操作;</td><td>0</td></tr><tr><td>0</td><td>MB</td><td>W1</td><td>MII忙标志位。该位由用户置位,表示命令硬件开始进行读或者写的操作,读写期间应保持物理地址,寄存器地址和数据域不变。在硬件将此位清零后,表示完成操作。</td><td>0</td></tr></table>

#### 27.1.8.1.5 MII 数据寄存器（R32_ETH_MACMIIDR）

偏移地址: $0 \times 1 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MD</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:16]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[15:0]</td><td>MD</td><td>RW</td><td>MII操作数据域。此域用来存放将要通过MII接口从物理层读取的数据，或者存放向物理层写入的数据。</td><td>0</td></tr></table>

#### 27.1.8.1.6 MAC 流控寄存器（R32_ETH_MACFCR）

偏移地址: $0 \times 1 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">PT</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="8">Reserved</td><td>ZQPD</td><td>Reser ved</td><td>PLT</td><td>UPFD</td><td>RFCE</td><td>TFCE</td><td colspan="2">FCB</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:16]</td><td>PT</td><td>RW</td><td>Pause间隔域。此域用来作为控制Pause时间域的值，单位为当前的MII接口发送64字节的耗时。</td><td>0</td></tr><tr><td>[15:8]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>7</td><td>ZQPD</td><td>RW</td><td>关闭零值Pause功能控制位。此位被置位时，将关闭自动零值Pause控制帧的生成。</td><td>0</td></tr><tr><td>6</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>[5:4]</td><td>PLT</td><td>RW</td><td>自动重发Pause帧阈值。这个域的值应该小于PT的值。重发时间等于PT减去PLT所代表的时间。00:4个时间间隙;01:28个时间间隙;10:144个时间间隙;</td><td>00b</td></tr><tr><td></td><td></td><td></td><td>11:256个时间间隙;</td><td></td></tr><tr><td>3</td><td>UPFD</td><td>RW</td><td>单播Pause帧检测位。
0:MAC只接收带协议规范定义的唯一地址的Pause帧;
1:MAC同时检测Pause帧是否MAC地址寄存器0中定义的单播地址;</td><td>0</td></tr><tr><td>2</td><td>RFCE</td><td>RW</td><td>接收流控使能位。
0:MAC不解析Pause帧。
1:MAC解析Pause帧并关闭发送器一段时间。</td><td>0</td></tr><tr><td>1</td><td>TFCE</td><td>RW</td><td>发送流控使能位。
0:MAC关闭发送流控,不发送Pause帧;
1:MAC使能发送流控,可以发送Pause帧;</td><td>0</td></tr><tr><td>0</td><td>FCB</td><td>W1</td><td>流控忙标志位。对此位置位可以发送一个Pause帧,发送完成后由硬件清零。在对整个MACFCR寄存器进行操作时,需要保证FCB位为0。</td><td>0</td></tr></table>

#### 27.1.8.1.7 VLAN 标签寄存器（MACVLAN）

偏移地址： ${ 0 } { \times 1 } { 0 }$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="15">Reserved</td><td>VLANT</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">VLANTI</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:17]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>16</td><td>VLANT</td><td>WR</td><td>标签比较控制位。0:将VLAN帧的第15,16字节的全部16位数据都与VLANTI域进行比较;1:只使用VLAN帧的第15,16字节的[11:0]位数据都与VLANTI域的相应位进行比较;</td><td>0</td></tr><tr><td>[15:0]</td><td>VLANTI</td><td>WR</td><td>标签对比样本域。根据IEEE 802.1协议,VLAN帧的第[15:13]位是用户优先级,[12]是规范格式指示符,位[11:0]VLANT标识符域。如果VLANTI全为0,那么MAC将不再关心VLAN帧的第15,16字节,而当其第13,14字节为0x8100(注意大小端)时即判定为VLAN帧。</td><td>0</td></tr></table>

#### 27.1.8.1.8 唤醒帧过滤寄存器（R32_MACRWUFFR）

偏移地址： $_ { 0 \times 2 8 }$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">RWUFFR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">RWUFFR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>RWUFFR</td><td>RW</td><td>唤醒帧过滤寄存器实际上时八个不同的寄存器,对其进行连续八次的读操作可以读出全部寄存器,同样对其进行连续八次的写操作可以写进全部八个寄存器。这八个寄存器各个位的说明详见14.5.6.3节的描述。</td><td>0</td></tr></table>

#### 27.1.8.1.9 PMT 控制和状态寄存器（R32_ETH_MACPMTCSR）

偏移地址： $\mathtt { 0 } \mathtt { x } 2 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>WFFRP</td><td colspan="15">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td></td><td colspan="5">Reserved</td><td>GU</td><td colspan="2">Reserved</td><td>WFR</td><td>MPR</td><td colspan="2">Reserved</td><td>WFE</td><td>MPE</td><td>PD</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>WFFRP</td><td>W</td><td>寄存器复位控制位。置此位会将 PMTCSR 寄存器全部清零。此位会在一个系统周期自动清零。</td><td>0</td></tr><tr><td>[30:10]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>9</td><td>GU</td><td>RW</td><td>全局单播位。置此位会使 MAC 将所有通过过滤器的单播帧都认为是唤醒帧。</td><td>0</td></tr><tr><td>[8:7]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>6</td><td>WFR</td><td>RZ</td><td>唤醒帧接收标志位。当收到唤醒帧时,此位会被置位。读取自动清零。</td><td>0</td></tr><tr><td>5</td><td>MPR</td><td>RZ</td><td>魔法帧接收标志位。当收到魔法帧时,此位会被置位。读取自动清零。</td><td>0</td></tr><tr><td>[4:3]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>2</td><td>WFE</td><td>RW</td><td>唤醒帧使能位。置此位允许在接收到唤醒帧时产生PMT 事件。</td><td>0</td></tr><tr><td>1</td><td>MPE</td><td>RW</td><td>魔法帧使能位。置此位允许在接收到魔法帧时产生PMT 事件。</td><td>0</td></tr><tr><td>0</td><td>PD</td><td>W</td><td>掉电控制位。置此位会使 MAC 进入掉电模式:丢弃其他所有帧,直到其收到了唤醒帧或魔法帧,唤醒后 MAC 自动清零。在置此位前需要将 WFE 或者 MPE 置位。</td><td>0</td></tr></table>

#### 27.1.8.1.10 MAC 中断状态寄存器（R32_ETH_MACSR）

偏移地址： ${ 0 } { \times } \ 3 { 8 }$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="5">Reserved</td><td>TSTS</td><td colspan="2">Reserved</td><td>MMCTS</td><td>MMCRS</td><td>MMCS</td><td>PMTS</td><td colspan="4">Reserved</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:10]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>9</td><td>TSTS</td><td>RZ</td><td>时间戳触发中断标志位。当到达PTP系统时钟设定的时间时,此标志位会被置位。</td><td>0</td></tr><tr><td>[8:7]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>6</td><td>MMCTS</td><td>R</td><td>MMC发送中断标志位。当MMC寄存器组中的MMCTIR寄存器产生任一中断时,该位置位。当MMC寄存器组中的MMCTIR寄存器全部清零时,此位也即清零。</td><td>0</td></tr><tr><td>5</td><td>MMCRS</td><td>R</td><td>MMC接收中断标志位。当MMC寄存器组中的MMCRIR寄存器产生任一中断时,该位置位。当MMC寄存器组中的MMCRIR寄存器全部清零时,此位也即清零。</td><td>0</td></tr><tr><td>4</td><td>MMCS</td><td>R</td><td>MMC状态标志位。当MMCTS或MMCRS置位时会触发此位置位;当MMCTS、MMCRS全部清零时此位即清零。</td><td>0</td></tr><tr><td>3</td><td>PMTS</td><td>R</td><td>PMT状态标志位。在掉电模式下,如果MAC收到魔法帧或者唤醒帧唤醒了MAC,那么此位会被置位;清除WFR和MPR两位后此位被清零。</td><td>0</td></tr><tr><td>[2:0]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr></table>

#### 27.1.8.1.11 MAC 中断屏蔽寄存器（R32_ETH_MACIMR）

偏移地址： $\mathtt { 0 } \mathtt { x } \mathtt { 3 0 }$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="6">Reserved</td><td>TSTIM</td><td colspan="5">Reserved</td><td>PMTIM</td><td colspan="3">Reserved</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:10]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>9</td><td>TSTIM</td><td>RW</td><td>时间戳中断屏蔽位。置此位将禁止产生时间戳中断。</td><td>0</td></tr><tr><td>[8:4]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>3</td><td>PMTIM</td><td>RW</td><td>PMT中断屏蔽位。置此位将屏蔽PMT中断。</td><td>0</td></tr><tr><td>[2:0]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr></table>

#### 27.1.8.1.12 MAC 地址寄存器 0 高 32 位（R32_ETH_MACA0HR）

偏移地址： $0 \times 4 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>MO</td><td colspan="15">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MACAOH</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>M0</td><td>R0</td><td>总是为1。</td><td>1</td></tr><tr><td>[30:16]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[15:0]</td><td>MACAOH</td><td>RW</td><td>MAC地址的高16位，即47:32位。</td><td>FFFFH</td></tr></table>

#### 27.1.8.1.13 MAC 地址寄存器 0 低 32 位（R32_ETH_MACA0LR）

偏移地址： $0 \times 4 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">MACAOL</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MACAOL</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>MACAOL</td><td>RW</td><td>MAC 地址的低 32 位，即 31:0 位。一般情况下，MAC 地址寄存器 0 的地址是 MAC 本身的地址。</td><td>FFFFFF
FFh</td></tr></table>

#### 27.1.8.1.14 MAC 地址寄存器 1 高 32 位（R32_ETH_MACA1HR）

偏移地址： $0 \times 4 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>AE</td><td>SA</td><td colspan="6">MBC</td><td colspan="8">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MACA1H</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>AE</td><td>RW</td><td>地址过滤使能位。0:地址过滤器忽略MAC地址1;1:地址过滤器使用MAC地址1来进行完美过滤;</td><td>0</td></tr><tr><td>30</td><td>SA</td><td>RW</td><td>地址角色选择位。0:MAC地址1被用来和接收到的帧的目标地址对比;1:MAC地址1被用来和接收到的帧的源地址对比;</td><td>0</td></tr><tr><td>[29:24]</td><td>MBC</td><td>RW</td><td>屏蔽字控制域。MBC的各个位用来对应屏蔽MAC地址1的某个字节,用来禁止将MAC地址1的某个字节参与到接收帧的源地址或目标地址的比较中。R32 ETH_MACA1HR[29]置位则屏蔽MACA1H[15:8];R32 ETH_MACA1HR[28]置位则屏蔽MACA1H[7:0];R32 ETH_MACA1HR[27]置位则屏蔽MACA1L[31:24];R32 ETH_MACA1HR[26]置位则屏蔽MACA1L[23:16];R32 ETH_MACA1HR[25]置位则屏蔽MACA1L[15:8];R32 ETH_MACA1HR[24]置位则屏蔽MACA1L[7:0]。</td><td>0</td></tr><tr><td>[23:16]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[15:0]</td><td>MACA1H</td><td>RW</td><td>MAC 地址的高 16 位，即 47:32 位。</td><td>FFFFH</td></tr></table>

#### 27.1.8.1.15 MAC 地址寄存器 1 低 32 位（R32_ETH_MACA1LR）

偏移地址： $\mathtt { 0 } \mathtt { x } 4 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">MACA1L</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MACA1L</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>MACA1L</td><td>RW</td><td>MAC 地址的低 32 位，即 31:0 位。</td><td>FFFFFF
FFh</td></tr></table>

#### 27.1.8.1.16 MAC 地址寄存器 2 高 32 位（R32_ETH_MACA2HR）

偏移地址： $_ { 0 \times 5 0 }$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>AE</td><td>SA</td><td colspan="6">MBC</td><td colspan="8">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MACA2H</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>AE</td><td>RW</td><td>地址过滤使能位。0:地址过滤器忽略MAC地址2;1:地址过滤器使用MAC地址2来进行完美过滤;</td><td>0</td></tr><tr><td>30</td><td>SA</td><td>RW</td><td>地址角色选择位。0:MAC地址2被用来和接收到的帧的目标地址对比;1:MAC地址2被用来和接收到的帧的源地址对比;</td><td>0</td></tr><tr><td>[29:24]</td><td>MBC</td><td>RW</td><td>屏蔽字控制域。MBC的各个位用来对应屏蔽MAC地址2的某个字节,用来禁止将MAC地址2的某个字节参与到接收帧的源地址或目标地址的比较中。R32 ETH_MACA2HR[29]置位则屏蔽MACA2H[15:8];R32 ETH_MACA2HR[28]置位则屏蔽MACA2H[7:0];R32 ETH_MACA2HR[27]置位则屏蔽MACA2L[31:24];R32 ETH_MACA2HR[26]置位则屏蔽MACA2L[23:16];R32 ETH_MACA2HR[25]置位则屏蔽MACA2L[15:8];R32 ETH_MACA2HR[24]置位则屏蔽MACA2L[7:0]。</td><td>0</td></tr><tr><td>[23:16]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>[15:0]</td><td>MACA2H</td><td>RW</td><td>MAC地址的高16位,即47:32位。</td><td>FFFFh</td></tr></table>

#### 27.1.8.1.17 MAC 地址寄存器 2 低 32 位（R32_ETH_MACA2LR）

偏移地址： $0 \times 5 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">MACA2L</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MACA2L</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31:0</td><td>MACA2L</td><td>RW</td><td>MAC 地址的低 32 位，即 31:0 位。</td><td>FFFFFF
FFh</td></tr></table>

#### 27.1.8.1.18 MAC 地址寄存器 3 高 32 位（R32_ETH_MACA3HR）

偏移地址： $_ { 0 \times 5 8 }$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>AE</td><td>SA</td><td colspan="6">MBC</td><td colspan="8">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MACA3H</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>AE</td><td>RW</td><td>地址过滤使能位。0:地址过滤器忽略MAC地址3;1:地址过滤器使用MAC地址3来进行完美过滤;</td><td>0</td></tr><tr><td>30</td><td>SA</td><td>RW</td><td>地址角色选择位。0:MAC地址3被用来和接收到的帧的目标地址对比;1:MAC地址3被用来和接收到的帧的源地址对比;</td><td>0</td></tr><tr><td>[29:24]</td><td>MBC</td><td>RW</td><td>屏蔽字控制域。MBC的各个位用来对应屏蔽MAC地址3的某个字节,用来禁止将MAC地址3的某个字节参与到接收帧的源地址或目标地址的比较中。R32 ETH_MACA3HR[29]置位则屏蔽MACA3H[15:8];R32 ETH_MACA3HR[28]置位则屏蔽MACA3H[7:0];R32 ETH_MACA3HR[27]置位则屏蔽MACA2L[31:24];R32 ETH_MACA3HR[26]置位则屏蔽MACA2L[23:16];R32 ETH_MACA3HR[25]置位则屏蔽MACA3L[15:8];R32 ETH_MACA3HR[24]置位则屏蔽MACA3L[7:0]。</td><td>0</td></tr><tr><td>[23:16]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>15:0</td><td>MACA3H</td><td>RW</td><td>MAC地址的高16位,即47:32位。</td><td>FFFFFFFFh</td></tr></table>

#### 27.1.8.1.19 MAC 地址寄存器 3 低 32 位（R32_ETH_MACA3LR）

偏移地址： $_ { 0 \times 5 0 }$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">MACA3L</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MACA3L</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>MACA3L</td><td>RW</td><td>MAC 地址的低 32 位，即 31:0 位。</td><td>FFFFFF
FFh</td></tr></table>

### 27.1.8.2 MMC 相关寄存器各位域

#### 27.1.8.2.1 MMC 控制寄存器（R32_ETH_MMCCR）

偏移地址： $0 \times 0 1 0 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="12">Reserved</td><td>MCF</td><td>ROR</td><td>CSR</td><td>CR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:4]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>3</td><td>MCF</td><td>RW</td><td>计数器冻结控制位。置此位会将 MMC 所有的计数器值全部冻结。复此位即恢复各计数器计数。在冻结时置位 ROR 再读取任意计数器,会导致该计数器清零。</td><td>0</td></tr><tr><td>2</td><td>ROR</td><td>RW</td><td>读时复位控制位。置此位会使读取任一计数器之后清零计数器的值。</td><td>0</td></tr><tr><td>1</td><td>CSR</td><td>RW</td><td>计数器回转停止位。置此位会使计数器增正到最大值后停止而不自动归零。</td><td>0</td></tr><tr><td>0</td><td>CR</td><td>W</td><td>计数器复位控制位。置此位将复位全部计数器。此位在一个系统周期后将自动清零。</td><td>0</td></tr></table>

#### 27.1.8.2.2 MMC 接收中断寄存器（R32_ETH_MMRIR）

偏移地址： $0 \times 0 1 0 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="14">Reserved</td><td>RGUFS</td><td>Reser ved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="10">Reserved</td><td>RFCES</td><td colspan="5">Reserved</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:18]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>17</td><td>RGUFS</td><td>RZ</td><td>接收好帧数量过半时会置此位。</td><td>0</td></tr><tr><td>[16:6]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>5</td><td>RFCES</td><td>RZ</td><td>接收CRC校验错误的帧数量过半时会置此位。</td><td>0</td></tr><tr><td>[4:0]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr></table>

#### 27.1.8.2.3 MMC 发送中断寄存器（R32_ETH_MMCTIR）

偏移地址： $0 \times 0 1 0 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="10">Reserved</td><td>TGFS</td><td colspan="5">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">Reserved</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:22]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>21</td><td>TGFS</td><td>RZ</td><td>发送帧数过半时此位会置位。</td><td>0</td></tr><tr><td>[20:0]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr></table>

#### 27.1.8.2.4 MMC 接收中断屏蔽寄存器（R32_ETH_MMRIMR）

偏移地址： $0 \times 0 1 0 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="14">Reserved</td><td>FGUFM</td><td>Reser ved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="10">Reserved</td><td>FRCRM</td><td colspan="5">Reserved</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:18]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>17</td><td>FGUFM</td><td>RW</td><td>接收好帧过半中断屏蔽位。置此位将屏蔽接收好帧计数器值达到一半时产生的中断。</td><td>0</td></tr><tr><td>[16:6]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>5</td><td>FRCRM</td><td>RW</td><td>接收CRC错误帧过半中断屏蔽位。置此位将屏蔽接收到CRC错误的帧计数器值达到一半时产生的中断。</td><td>0</td></tr><tr><td>[4:0]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr></table>

#### 27.1.8.2.5 MMC 发送中断屏蔽寄存器（R32_ETH_MMCTIMR）

偏移地址： $0 \times 0 1 1 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="10">Reserved</td><td>TGFM</td><td colspan="5">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">Reserved</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:22]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>21</td><td>TGFM</td><td>RW</td><td>发送好帧过半中断屏蔽位。置此位将屏蔽发送好帧计数器值达到一半时产生的中断。</td><td>0</td></tr><tr><td>[20:0]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr></table>

#### 27.1.8.2.6 MMC 一次冲突后发生好帧计数器（R32_ETH_MMCTGFSCCR）

偏移地址： $0 \times 0 1 4 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TGFSCCR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TGFSCCR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TGFSCCR</td><td>R0</td><td>这个域用来统计半双工模式下，发生帧时只遇到一次冲突的计数器。</td><td>0</td></tr></table>

#### 27.1.8.2.7 MMC 多次冲突后发生好帧计数器（R32_ETH_MMCTGFMSCCR）

偏移地址： $0 \times 0 1 5 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TGFMSCCR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TGFMSCCR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TGFMSCCR</td><td>R0</td><td>这个域用来统计半双工模式下，发生帧时只遇到一次以上冲突的计数器。</td><td>0</td></tr></table>

#### 27.1.8.2.8 MMC 发送好帧计数寄存器（R32_ETH_MMCTGFCR）

偏移地址： $0 \times 0 1 6 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TGFC</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TGFC</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TGFC</td><td>RO</td><td>MAC发送出去的正确帧的计数量。</td><td>0</td></tr></table>

#### 27.1.8.2.9 MMC 接收 CRC 有误帧计数寄存器（R32_ETH_MMCRFCECR）

偏移地址： $0 \times 0 1 9 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">RFCECR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">RFCECR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>RFCECR</td><td>RO</td><td>MAC接收到的存在CRC校验错误的帧的计数器。</td><td>0</td></tr></table>

#### 27.1.8.2.10 MMC 接收对齐错误计数器寄存器（R32_ETH_MMCRFAECR）

偏移地址： $0 \times 0 1 9 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">RFAECR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">RFAECR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>RFAECR</td><td>RO</td><td>MAC接收到的存在对齐错误的帧的计数器。</td><td>0</td></tr></table>

#### 27.1.8.2.11 MMC 接收好帧计数寄存器（R32_ETH_MMCRGUFCR）

偏移地址： $0 { \times } 0 1 0 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">RGUFCR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">RGUFCR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>RGUFCR</td><td>RO</td><td>MAC 接收到的正常的帧的数量。</td><td>0</td></tr></table>

### 27.1.8.3 IEEE 1588（PTP）相关寄存器各位域

#### 27.1.8.3.1 PTP 时间戳控制寄存器（R32_ETH_PTPTSCR）

偏移地址： $0 \times 0 7 0 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr></table>

<table><tr><td>Reserved</td><td>TSARU</td><td>TSITE</td><td>TSSTU</td><td>TSSTI</td><td>TSFCU</td><td>TSE</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:6]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>5</td><td>TSARU</td><td>RW</td><td>加数寄存器更新控制位。置此位后,加数寄存器的值将会加到累加器中。精调模式下使用此位。累加器自增完毕后此位自动清零。此位只能在为0时置位。</td><td>0</td></tr><tr><td>4</td><td>TSITE</td><td>RW</td><td>时间戳中断触发使能位。置此位后,当PTP系统时间达到设定目标时间寄存器的值时,将产生中断。</td><td>0</td></tr><tr><td>3</td><td>TSSTU</td><td>RW</td><td>系统时间更新控制位。置此位后,PTP系统时间将加上更新寄存器中的值。更新完毕后此位自动清零。</td><td>0</td></tr><tr><td>2</td><td>TSSTI</td><td>RW</td><td>时间戳初始化控制位。置此位后,PTP的系统时间将会被替换成更新寄存器中的值。更新完毕后此位自动清零。</td><td>0</td></tr><tr><td>1</td><td>TSFCU</td><td>RW</td><td>更新模式选择控制位。0:表示使用粗调模式;1:表示使用精调模式;</td><td>0</td></tr><tr><td>0</td><td>TSE</td><td>RW</td><td>附加时间戳使能位。0:不向描述符中添加时间戳;1:发送或接收完成后,向描述符中添加时间戳;</td><td>0</td></tr></table>

#### 27.1.8.3.2 PTP 亚秒递增寄存器（R32_ETH_PTPSSIR）

偏移地址： $0 { \times } 0 7 0 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="8">Reserved</td><td colspan="8">STSSI</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:8]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[7:0]</td><td>STSSI</td><td>RW</td><td>亚秒步进值。在粗调模式下,每个主频周期,PTP系统时间会自增这个值;在精调模式下,在累加器溢出时,PTP系统时间会自增这个值。</td><td>00h</td></tr></table>

#### 27.1.8.3.3 PTP 时间戳寄存器高位（R32_ETH_PTPTSHR）

偏移地址： $0 \times 0 7 0 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">STS</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">STS</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TSHR</td><td>R0</td><td>PTP系统时间值，实时值，单位为秒。</td><td>0</td></tr></table>

#### 27.1.8.3.4 PTP 时间戳寄存器低位（R32_ETH_PTPTSLR）

偏移地址： $0 \times 0 7 0 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>STPNS</td><td colspan="15">STSS</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">STSS</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>STPNS</td><td>R0</td><td>系统时间正负标志位。1表示当前时间为负，0表示当前时间为正。</td><td>0</td></tr><tr><td>[30:0]</td><td>STSS</td><td>R0</td><td>PTP系统时间值，实时值，单位为亚秒，即约0.46纳秒。STSS溢出时，STS自增1秒。</td><td>0</td></tr></table>

#### 27.1.8.3.5 PTP 时间戳更新寄存器高 32 位（R32_ETH_PTPTSHUR）

偏移地址： $0 \times 0 7 1 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TSUS</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TSUS</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TSUS</td><td>RW</td><td>时间戳更新秒值，用来替换到PTP系统时间高位或者表示其在系统时间上加减的秒值。</td><td>0</td></tr></table>

#### 27.1.8.3.6 PTP 时间戳更新寄存器低 32 位（R32_ETH_PTPTSLUR）

偏移地址： $0 { \times } 0 7 1 4$

<table><tr><td>TSUPN
S</td><td colspan="14">TSUSS</td><td></td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="15">TSUSS</td><td></td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>TSUPNS</td><td>RW</td><td>时间戳更新正负标志位。当更新时间方式为使用TSUS和TSUSS直接替换PTP系统时间时,TSUPNS应为0;当更新时间方式为使用TSUS和TSUSS作在</td><td>0</td></tr><tr><td></td><td></td><td></td><td>原PTP系统时间值上的加减时,TSUPNS为1表示在PTP系统时间的基础上减去TSUS和TSUSS,为0表示在PTP系统时间的基础上加上TSUS和TSUSS。</td><td></td></tr><tr><td>[30:0]</td><td>TSUSS</td><td>RW</td><td>时间戳更新亚秒值,用来替换到PTP系统时间高位或者表示其在系统时间上加减的亚秒值。</td><td>0</td></tr></table>

#### 27.1.8.3.7 PTP 时间戳加数寄存器（R32_ETH_PTPTSAR）

偏移地址： $0 \times 0 7 1 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TSA</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TSA</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TSA</td><td>RW</td><td>时间戳加数值。这个寄存器只在精调模式下才会被使用。TSA的值会在每个系统周期被加到累加器中,如果累加器溢出,则会触发精调模式下的系统时间更新。</td><td>0</td></tr></table>

#### 27.1.8.3.8 PTP 目标时间寄存器高 32 位（R32_ETH_PTPTTHR）

偏移地址： $0 { \times } 0 7 1 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TTSH</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TTSH</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TTSH</td><td>RW</td><td>目标时间秒值。如果PTP系统时间达到或者超过这个值，且使能了相关中断，那么会产生一个中断。</td><td>0</td></tr></table>

#### 27.1.8.3.9 PTP 目标时间寄存器高 32 位（R32_ETH_PTPTTHR）

偏移地址： $0 \times 0 7 2 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TTSL</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TTSL</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TTSL</td><td>RW</td><td>目标时间亚秒值。如果PTP系统时间达到或超过这个值，且使能了相关中断，那么会产生一个中断。</td><td>0</td></tr></table>

### 27.1.8.4 DMA 控制相关寄存器各位域

#### 27.1.8.4.1 DMA 总线模式寄存器（R32_ETH_DMABMR）

偏移地址： $0 \times 1 0 0 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="9">Reserved</td><td colspan="4">DSL</td><td>Reser ved</td><td colspan="2">SR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:7]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[6:2]</td><td>DSL</td><td>RW</td><td>描述符跳跃长度:这些位定义了2个不以链式结构连接的描述符之间的跳跃距离,单位为字(32位)。地址跳跃是指从当前描述符的结尾到下一个描述符开头的地址差值。当DSL域为0时,在环形结构下,DMA认为描述符是相邻地连续排列的。</td><td>0</td></tr><tr><td>1</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>0</td><td>SR</td><td>RW</td><td>软件复位:置1时,MAC的DMA控制器复位MAC所有子系统的内部寄存器和逻辑电路。在MAC内部不同时钟域模块完成复位操作后,自动清除该位。在重新写MAC的寄存器前,应当确保该位为0。</td><td>1</td></tr></table>

#### 27.1.8.4.2 DMA 发送查询寄存器（R32_ETH_DMATPDR）

偏移地址： $0 \times 1 0 0 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TPDR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TPDR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TPDR</td><td>RW</td><td>发送查询命令。用户通过向这个寄存器写任意值来启动被暂停的发送流程。重启发送流程后，这个寄存器会被自动清零。</td><td>0</td></tr></table>

#### 27.1.8.4.3 DMA 接收查询寄存器（R32_ETH_DMARPDR）

偏移地址： $0 \times 1 0 0 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">RPDR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">RPDR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>RPDR</td><td>RW</td><td>接收查询命令。接收流程可能会被各种意外而打断，需要用户向这个寄存器写任意值来重启接收流程。重启接收流程后，这个寄存器会被自动清零。</td><td>0</td></tr></table>

#### 27.1.8.4.4 DMA 接收描述符地址寄存器（R32_ETH_DMARDLAR）

偏移地址： $0 \times 1 0 0 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">RDLAR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">RDLAR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>RDLAR</td><td>RW</td><td>这个寄存器用来存储第一个接收 DMA 描述符的地址。注意描述符需要 16 字节对齐,所以这个寄存器的后 4 位应该为 0 。</td><td>0</td></tr></table>

#### 27.1.8.4.5 DMA 发送描述符地址寄存器（R32_ETH_DMATDLAR）

偏移地址： $0 \times 1 0 1 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">TDLAR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">TDLAR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>TDLAR</td><td>RW</td><td>这个寄存器用来存储第一个发送 DMA 描述符的地址。注意描述符需要 16 字节对齐,所以这个寄存器的后 4 位应该为 0 。</td><td>0</td></tr></table>

#### 27.1.8.4.6 DMA 状态寄存器（R32_ETH_DMASR）

偏移地址： $0 \times 1 0 1 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>PLS</td><td>Reser ved</td><td>TSTS</td><td>PMTS</td><td>MMCS</td><td>Reser ved</td><td colspan="3">EBS</td><td colspan="3">TPS</td><td colspan="3">RPS</td><td>NIS</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td>AIS</td><td>ERS</td><td>FBES</td><td colspan="2">Reserved</td><td>ETS</td><td>RWTS</td><td>RPSS</td><td>RBUS</td><td>RS</td><td>TUS</td><td>ROS</td><td>TJTS</td><td>TBUS</td><td>TPSS</td><td>TS</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>PLS</td><td>RW1Z</td><td>内部10M物理层连接状态改变标志位。此位置位表示物理层连接上或者已断开。或写1清零。</td><td>0</td></tr><tr><td>30</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>29</td><td>TSTS</td><td>R0</td><td>时间戳触发状态标志位。在PTP部分产生中断事件时,此位会被置位,如果使能了PTP中断则会产生中断。清除PTP部分的全部标志位后,此位会自动清除。</td><td>0</td></tr><tr><td>28</td><td>PMTS</td><td>R0</td><td>PMT触发状态标志位。在PMT部分产生中断事件时,此位会被置位,如果使能了PMT中断则会产生中断。清除PMT部分的全部标志位后,此位会自动清除。</td><td>0</td></tr><tr><td>27</td><td>MMCS</td><td>R0</td><td>MMC触发状态标志位。在MMC部分产生中断事件时,此位会被置位,如果使能了MMC中断则会产生中断。清除MMC部分的全部标志位后,此位会自动清除。</td><td>0</td></tr><tr><td>26</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[25:23]</td><td>EBS</td><td>R0</td><td>错误状态域。该域表示造成总线错误的类型。此域只在DMASR[13]位被置位的情况下才有效。DMASR[23]:0:发送DMA转发数据时出错;1:接收DMA转发数据时出错;DMASR[24]:0:读数据转发时出错;R01:写数据转发时出错;DMASR[25]:0:访问描述符时出错;1:访问数据缓存时出错;</td><td>0</td></tr><tr><td>[22:20]</td><td>TPS</td><td>R0</td><td>发送流程状态域。这个域用来表示当前发送DMA的状态。000:停止,接收到复位或者停止发送命令;001:运行,正在取发送描述符;010:运行,正在等待状态信息;011:运行,正在读取发送缓冲区数据并压进FIFO;100,101:保留;110:暂停,发送描述符不可用或者发送缓存数据下溢;111:运行,正在关闭发送描述符;</td><td>000b</td></tr><tr><td>[19:17]</td><td>RPS</td><td>R0</td><td>接收流程状态域。这个域用来表示当前接收DMA的状态。000:停止,接收到复位或者停止发送命令;</td><td>000b</td></tr><tr><td></td><td></td><td></td><td>001: 运行,正在取接收描述符;010: 保留;011: 运行,正在等待接收数据包;100: 暂停,接收描述符不可用;101: 运行,正在关闭接收描述符;110: 保留;111: 运行,正在把接收数据从FIFO压入内存中;</td><td></td></tr><tr><td>16</td><td>NIS</td><td>RW1Z</td><td>正常中断汇总位。在DMAIER 寄存器中使能的中断下,如果下列位任一被置位,NIS位同样会被置位。-DMASR[0]:发送中断;-DMASR[2]:发送缓存不可用;-DMASR[6]:接收中断;-DMASR[14]:早接收中断;-DMASR[31]:内部10M物理层连接状态改变NIS位为黏着位,当导致NIS位置1的对应中断状态位被清零时,必须通过写1的方式将NIS位也清零;</td><td>0</td></tr><tr><td>15</td><td>AIS</td><td>RW1Z</td><td>异常中断汇总位。在DMAIER 寄存器中使能的中断下,如果下列位任一被置位,AIS位同样会被置位。-DMASR[1]:发送流程停止;-DMASR[3]:发送啰嗦(Jabber)超时;-DMASR[4]:接收FIFO溢出;-DMASR[5]:发送数据下溢;-DMASR[7]:发送缓存不可用;-DMASR[8]:接收流程停止;-DMASR[9]:接收看门狗超时;-DMASR[10]:早发送;-DMASR[13]:总线错误;将以上所有的位清零,则AIS位将自动清零;</td><td>0</td></tr><tr><td>14</td><td>ERS</td><td>RW1Z</td><td>早接收状态位。该位被置位时,表示收到数据帧时DMA已经填满了第一个缓冲区,但是完整的帧还没接收完毕。RS置位后,ERS位自动清零。</td><td>0</td></tr><tr><td>13</td><td>FBES</td><td>RW1Z</td><td>总线错误位。该位被置位时,表示发送了总线错误。具体原因见[25:23]位。该位被置位后,相应的DMA控制器将关闭总线访问。</td><td>0</td></tr><tr><td>[12:11]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>10</td><td>ETS</td><td>RW1Z</td><td>早发送状态位。置位时表示发送帧已经全部压入FIFO。</td><td>0</td></tr><tr><td>9</td><td>RWTS</td><td>RW1Z</td><td>看门狗超时标志位。置位时表示帧长已经超过了2048字节。</td><td>0</td></tr><tr><td>8</td><td>RPSS</td><td>RW1Z</td><td>接收流程停止状态位。该位置位表示接收流程已经停止。</td><td>0</td></tr><tr><td>7</td><td>RBUS</td><td>RW1Z</td><td>接收缓存不可用状态位。该位置位表示接收描述符权限归属CPU,DMA无法获得,接收流程已经暂停。用户需要释放描述符并向RPDR寄存器中填入一个值来恢复接收流程。DMA会在接收下一帧时重试获</td><td>0</td></tr><tr><td></td><td></td><td></td><td>取描述符。</td><td></td></tr><tr><td>6</td><td>RS</td><td>RW1Z</td><td>接收完成状态位。该位置位表示已经完成一帧的接收,帧信息也更新到描述符中。</td><td>0</td></tr><tr><td>5</td><td>TUS</td><td>RW1Z</td><td>发送数据下溢位。该位置位表示发送缓存在发送帧时发生了发送数据下溢。此时发送进程暂停并把数据下溢错误位置位。</td><td>0</td></tr><tr><td>4</td><td>ROS</td><td>RW1Z</td><td>接收状态溢出位。该位被置位表示接收缓冲发生了数据溢出。</td><td>0</td></tr><tr><td>3</td><td>TJTS</td><td>RW1Z</td><td>发送啰嗦(Jabber)定时器超时位。该位被置位表示发送器过于繁忙,发送已经停止,描述符的啰嗦(Jabber)超时位已经置位。</td><td>0</td></tr><tr><td>2</td><td>TBUS</td><td>RW1Z</td><td>发送缓存不可用状态位。该位被置位表示发送描述符被CPU占用,DMA无法获取,发送流程已经暂停。第[22:20]位显示了当前的发送状态。应用程序需要释放发送描述符。</td><td>0</td></tr><tr><td>1</td><td>TPSS</td><td>RW1Z</td><td>发送流程停止状态位。该位被置位表示发送流程已经停止。</td><td>0</td></tr><tr><td>0</td><td>TS</td><td>RW1Z</td><td>发送完成标志位。该位被置位表示已经完成一帧的发送,描述符归属权已经交还CPU。</td><td>0</td></tr></table>

#### 27.1.8.4.7 DMA 操作模式寄存器（R32_ETH_DMAOMR）

偏移地址： $0 \times 1 0 1 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="4">Reserved</td><td>DTCEF D</td><td colspan="5">Reserved</td><td>TSF</td><td>FTF</td><td colspan="4">Reserved</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td>Reserved</td><td>ST</td><td colspan="5">Reserved</td><td>FEF</td><td>FUGF</td><td colspan="4">Reserved</td><td>SR</td><td colspan="2">Reserved</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:27]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>26</td><td>DTCEFD</td><td>RW</td><td>不丢弃 TCP/IP 校验和错误帧控制位。0: 如果 FEF 位为 0, MAC 会丢弃所有有错误的帧;1: 发现 TCP/IP/ICMP/UDP 之类协议的检验和存在错误时, 不丢弃该帧;</td><td>0</td></tr><tr><td>[25:22]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>21</td><td>TSF</td><td>RW</td><td>发送存储转发控制位。0: 发送流程写入 FIFO0 的数据达到确定值之后就会启动发送;1: 发送流程将完整的帧全部写入 FIFO0 后才会启动发送;</td><td>0</td></tr><tr><td>20</td><td>FTF</td><td>RW</td><td>发送 FIFO0 清空控制位。置此位将复位发送 FIFO0。</td><td>0</td></tr><tr><td>[19:14]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>13</td><td>ST</td><td>RW</td><td>开始或停止发送控制位。</td><td>0</td></tr><tr><td></td><td></td><td></td><td>0:发送完当前帧之后,发送进程进入停止状态;1:把发送进程置为运行状态。</td><td></td></tr><tr><td>[12:8]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>7</td><td>FEF</td><td>RW</td><td>转发错误帧控制位。0:除了过短的帧之外,所有的帧都会转发给DMA。1:接收FIFO会丢弃有错误的帧。</td><td>0</td></tr><tr><td>6</td><td>FUGF</td><td>RW</td><td>转发过短的帧控制位。0:接收FIFO丢弃所有长度小于64字节的帧;1:接收FIFO转发长度过短的帧。</td><td>0</td></tr><tr><td>[5:2]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>1</td><td>SR</td><td>RW</td><td>开始或停止接收控制位。0:在转发完当前接收到的帧后,接收DMA进入停止模式,下一次传输从当前接收描述符位置开始;1:开启接收流程,DMA从当前位置取接收描述符或者从标识符表头位置取接收描述符。</td><td>0</td></tr><tr><td>0</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr></table>

#### 27.1.8.4.8 DMA 中断使能寄存器（R32_ETH_DMAIER）

偏移地址： $0 \times 1 0 1 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td>PLE</td><td colspan="14">Reserved</td><td>NISE</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td>AISE</td><td>ERS</td><td>FBES</td><td>Reserved</td><td>ETIE</td><td>RWTIE</td><td>RPSIE</td><td>RBUIE</td><td>RIE</td><td>TUIE</td><td>ROIE</td><td>TJTIE</td><td>TBUIE</td><td>TPSIE</td><td>TIE</td><td></td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>31</td><td>PLE</td><td>RW</td><td>内部10M物理层连接状态改变中断使能位。</td><td>0</td></tr><tr><td>[30:17]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>16</td><td>NISE</td><td>RW</td><td>正常中断使能位。使能该位将使能以下中断。-DMASR[0]:发送中断;-DMASR[2]:发送缓存不可用;-DMASR[6]:接收中断-DMASR[14]:早接收中断</td><td>0</td></tr><tr><td>15</td><td>AISE</td><td>RW</td><td>异常中断。使能该位将使能以下中断。-DMASR[1]:发送流程停止;-DMASR[3]:发送啰嗦(Jabber)超时;-DMASR[4]:接收FIFO溢出;-DMASR[5]:发送数据下溢;-DMASR[7]:发送缓存不可用;-DMASR[8]:接收流程停止;-DMASR[9]:接收看门狗超时;-DMASR[10]:早发送;-DMASR[13]:总线错误;</td><td>0</td></tr><tr><td>14</td><td>ERS</td><td>RW</td><td>早接收中断使能位。使能该位即可以产生早接收中断。NISE须置位。AISE须置位。</td><td>0</td></tr><tr><td>13</td><td>FBES</td><td>RW</td><td>总线致命错误中断使能位。使能该位即可以产生总线错误中断。AISE须置位。</td><td>0</td></tr><tr><td>[12:11]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>10</td><td>ETIE</td><td>RW</td><td>早发送中断使能位。使能该位即可以产生早发送中断。AISE须置位。</td><td>0</td></tr><tr><td>9</td><td>RWTIE</td><td>RW</td><td>接收看门狗中断使能位。使能该位即可以产生接收看门狗超时中断。AISE须置位。</td><td>0</td></tr><tr><td>8</td><td>RPSIE</td><td>RW</td><td>接收流程停止中断使能位。使能该位即可以产生接受流程停止中断。</td><td>0</td></tr><tr><td>7</td><td>RBUIE</td><td>RW</td><td>接收缓存不可用中断使能位。使能该位即可以产生接受缓存不可用中断。AISE须置位。</td><td>0</td></tr><tr><td>6</td><td>RIE</td><td>RW</td><td>接收完成中断使能位。使能该位即可以产生接收完成中断。NISE须置位。</td><td>0</td></tr><tr><td>5</td><td>TUIE</td><td>RW</td><td>发送下溢中断使能。使能该位即可以产生发送下溢中断。AISE须置位。</td><td>0</td></tr><tr><td>4</td><td>ROIE</td><td>RW</td><td>接收溢出中断。使能该位即可以产生接收溢出中断。AISE须置位。</td><td>0</td></tr><tr><td>3</td><td>TJTIE</td><td>RW</td><td>发送啰嗦(Jabber)超时中断使能。使能该位即可以产生发送啰嗦(Jabber)超时中断。AISE须置位。</td><td>0</td></tr><tr><td>2</td><td>TBUIE</td><td>RW</td><td>发送缓存不可用中断使能。使能该位即可以产生发送缓存不可用中断。NISE须置位</td><td>0</td></tr><tr><td>1</td><td>TPSIE</td><td>RW</td><td>发送流程停止中断使能。使能该位即可以产生发送流程停止中断。AISE须置位。</td><td>0</td></tr><tr><td>0</td><td>TIE</td><td>RW</td><td>发送完成中断使能。使能该位即可以产生发送完成中断。NISE须置位。</td><td>0</td></tr></table>

#### 27.1.8.4.9 DMA 丢失帧寄存器（R32_ETH_DMAMFBOCR）

偏移地址： $0 \times 1 0 2 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="15">Reserved</td><td>OMFC</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">MFC</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:17]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>16</td><td>OMFC</td><td>RW</td><td>丢失帧计数器溢出位。</td><td>0</td></tr><tr><td>[15:0]</td><td>MFC</td><td>RW</td><td>丢失帧计数器。这个域表示由于接收缓冲区不可用导致的帧丢失的数量。</td><td>0</td></tr></table>

#### 27.1.8.4.10 DMA 当前发送描述符寄存器（R32_ETH_DMACHTDR）

偏移地址： $0 \times 1 0 4 8$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">HTDAR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">HTDAR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>HTDAR</td><td>RO</td><td>这个寄存器值指向目前正在使用的发送描述符。此寄存器由DMA负责实时更新。</td><td>0</td></tr></table>

#### 27.1.8.4.11 DMA 当前接收描述符寄存器（R32_ETH_DMACHRDR）

偏移地址： $0 \times 1 0 4 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">HRDAR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">HRDAR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>HRDAR</td><td>R0</td><td>这个寄存器值指向目前正在使用的接收描述符。此寄存器由DMA负责实时更新。</td><td>0</td></tr></table>

#### 27.1.8.4.12 DMA 当前发送缓冲区寄存器（R32_ETH_DMACHTBAR）

偏移地址： $0 \times 1 0 5 0$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">HTBAR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">HTBAR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>HTBAR</td><td>RO</td><td>这个寄存器值指向目前正在使用的发送缓冲区。此寄存器由DMA负责实时更新。</td><td>0</td></tr></table>

#### 27.1.8.4.13 DMA 当前接收缓冲区寄存器（R32_ETH_DMACHRBAR）

偏移地址： $0 \times 1 0 5 4$

<table><tr><td>31</td><td>30</td><td>29</td><td>28</td><td>27</td><td>26</td><td>25</td><td>24</td><td>23</td><td>22</td><td>21</td><td>20</td><td>19</td><td>18</td><td>17</td><td>16</td></tr><tr><td colspan="16">HRBAR</td></tr><tr><td>15</td><td>14</td><td>13</td><td>12</td><td>11</td><td>10</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr><tr><td colspan="16">HRBAR</td></tr></table>

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>HRBAR</td><td>R0</td><td>这个寄存器值指向目前正在使用的接收缓冲区。此寄存器由DMA负责实时更新。</td><td>0</td></tr></table>

### 27.1.8.5 内部 10M 物理层相关寄存器地址

#### 27.1.8.5.1 基础控制寄存器（BMCR）

偏移地址： $0 \times 0 0$   

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>15</td><td>RST</td><td>RW/SC</td><td>1: PHY 复位;0: 正常操作;</td><td>0</td></tr><tr><td>14</td><td>Loopback</td><td>RW</td><td>1: 使能回环;0: 正常操作;</td><td>0</td></tr><tr><td>13</td><td>Speed Selection</td><td>RO</td><td>0: 10Mb/s;</td><td>0</td></tr><tr><td>12</td><td>Auto-Negotiation</td><td>RW</td><td>1: 使能自动协商;0: 禁止自动协商;</td><td>1</td></tr><tr><td>[11:10]</td><td>Reserved</td><td>RO</td><td>保留;</td><td>0</td></tr><tr><td>9</td><td>Restart Auto-Negotiation</td><td>RW/SC</td><td>1: 重新自动协商;0: 正常操作;</td><td>0</td></tr><tr><td>8</td><td>Duplex Mode</td><td>RW</td><td>1: 全双工;0: 半双工;</td><td>1</td></tr><tr><td>7</td><td>Collision Test</td><td>RW</td><td>1: 冲突检测使能;0: 正常操作;</td><td>0</td></tr><tr><td>[6:0]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr></table>

#### 27.1.8.5.2 基础状态寄存器（BMSR）

地址偏移： $0 \times 0 1$   

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位</td></tr><tr><td>[15:6]</td><td>Reserved</td><td>R0</td><td>保留;</td><td>0</td></tr><tr><td>5</td><td>Auto-Negotiation Complete</td><td>R0</td><td>1:自动协商完成;0:自动协商未完成;</td><td>0</td></tr><tr><td>[4:3]</td><td>Reserved</td><td>R0</td><td>保留;</td><td>0</td></tr><tr><td>2</td><td>Link</td><td>R0</td><td>1:物理层建立链接;0:物理层未建立链接;</td><td>0</td></tr><tr><td>[1:0]</td><td>Reserved</td><td>R0</td><td>保留;</td><td>0</td></tr></table>

#### 27.1.8.5.3 自动协商链接方能力寄存器（R16_ETH_ANLPAR）

偏移地址： $0 \times 0 5$   

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>15</td><td>NP</td><td>R0</td><td>下一页位。
1:发送协议细节数据页;
0:发送基本能力数据页。</td><td>0</td></tr><tr><td>14</td><td>ACK</td><td>R0</td><td>1:链接方确认接收到本地节点的能力数据字;
0:没有应答。</td><td>0</td></tr><tr><td>13</td><td>RF</td><td>R0</td><td>1:链接方正在指示一个远端故障;
0:链接方没有指示远端故障。</td><td>0</td></tr><tr><td>12</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>11</td><td>ASYPAUSE</td><td>R0</td><td>1:链接方支持非对称流控;0:链接方不支持非对称流控。启用自动协商时,此位反映链接方的能力。</td><td>0</td></tr><tr><td>10</td><td>PAUSE</td><td>R0</td><td>1:链接方支持流控;0:链接方不支持流控。启用自动协商时,此位反映链接方的能力。(只读)。</td><td>0</td></tr><tr><td>9</td><td>100Base-T4</td><td>R0</td><td>1:链接方支持100Base-T4;0:链接方不支持100Base-T4。</td><td>0</td></tr><tr><td>8</td><td>100Base-TX-FD</td><td>R0</td><td>1:链接方支持100Base-TX全双工;0:链接方不支持100Base-TX全双工。</td><td>0</td></tr><tr><td>7</td><td>100Base-TX</td><td>R0</td><td>1:链接方支持100Base-TX;0:链接方不支持100Base-TX。由并行检测建立了100Base-TX链接之后,该位同样会被置位。</td><td>0</td></tr><tr><td>6</td><td>10Base-T-FD</td><td>R0</td><td>1:链接方支持10Base-TX全双工;0:链接方不支持10Base-TX全双工。</td><td>0</td></tr><tr><td>5</td><td>10Base-T</td><td>R0</td><td>1:链接方支持10Base-T;0:链接方不支持10Base-T。由并行检测建立了10Base-T链接之后,该位同样会被置位。</td><td>0</td></tr><tr><td>[4:0]</td><td>SELECT</td><td>R0</td><td>链接方的二进制编码节点选择器,当前仅CSMA/CD &lt;00001&gt;被指定。</td><td>00001b</td></tr></table>

#### 27.1.8.5.4 物理层状态寄存器（PHYSR）

偏移地址： $0 \times 1 0$   

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:4]</td><td>Reserved</td><td>R0</td><td>保留;</td><td>0</td></tr><tr><td>3</td><td>Loopback_10M</td><td>R0</td><td>1: PHY工作于10M自循环0:正常模式</td><td>0</td></tr><tr><td>2</td><td>Full_10M</td><td>R0</td><td>1: PHY工作于10M全双工0:半双工模式</td><td>0</td></tr><tr><td>[1:0]</td><td>Reserved</td><td>R0</td><td>保留;</td><td>0</td></tr></table>

#### 27.1.8.5.5 自动翻转寄存器（MDIX）

偏移地址寄存器：0x1E  

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:4]</td><td>Reserved</td><td>R0</td><td>保留;</td><td>0</td></tr><tr><td>[3:2]</td><td>P/N极性</td><td>RW</td><td>1x:保留。
00:P/N极性正常
01:P/N极性颠倒</td><td>00b</td></tr><tr><td>[1:0]</td><td>T/R选择</td><td>RW</td><td>00:自动</td><td>00b</td></tr><tr><td></td><td></td><td></td><td>01: MDIX
1x: MDI</td><td></td></tr></table>

## 27.2 CH32F20x_D8W、CH32V20x_D8、CH32V20x_D8W 系列

### 27.2.1 以太网控制器简介

芯片集成了以太网控制器 MAC 和 PHY 以及 DMA，兼容 IEEE802.3 协议。内部 DMA 传输数据和接收数据到系统 RAM 中。PHY 物理层是一个 10Mbit/S 的以太网络收发器，提供部分网络 PHY 寄存器，可以设置发送和接收性能。

网络底层操作主要以子程序库提供应用支持，对寄存器不作详细介绍。主要特性：

支持全双工和半双工。  
支持短包填充设置。  
$\bullet$ 支持 CRC 设置和填充。  
支持巨型帧接收。  
支持不同的过滤模式组合。  
$\bullet$ 支持 pause 帧发送和设置。  
$\bullet$ 支持自动协商机制。  
$\bullet$ 支持 DMA，用于发送和接收数据。  
PHY 收发器兼容 10BASE-T，发送模块支持节能模式。  
$\bullet$ 内置 50 欧姆传输阻抗匹配电阻，也可选择外接。  
提供由 IEEE 分配的全球唯一 MAC 地址。

### 27.2.2 寄存器描述

表27-23 以太网控制器相关寄存器列表  

<table><tr><td>名称</td><td>偏移地址</td><td>描述</td><td>复位值</td></tr><tr><td>R8_ETH_EIE</td><td>0x40028003</td><td>中断使能寄存器</td><td>0x00</td></tr><tr><td>R8_ETH_EIR</td><td>0x40028004</td><td>中断标志寄存器</td><td>0x00</td></tr><tr><td>R8_ETH_ESTAT</td><td>0x40028005</td><td>状态寄存器</td><td>0x00</td></tr><tr><td>R8_ETH_ECON2</td><td>0x40028006</td><td>PHY模拟参数设置寄存器</td><td>0x06</td></tr><tr><td>R8_ETH_ECON1</td><td>0x40028007</td><td>收发控制寄存器</td><td>0x00</td></tr><tr><td>R32_ETH_TX</td><td>0x40028008</td><td>发送DMA控制寄存器</td><td>0xXXXXXXXXX</td></tr><tr><td>R16_ETH_ETXST</td><td>0x40028008</td><td>发送DMA缓存区起始地址寄存器</td><td>0xXXXX</td></tr><tr><td>R16_ETH_ETXLN</td><td>0x4002800A</td><td>发送长度寄存器</td><td>0xXXXX</td></tr><tr><td>R32_ETH_RX</td><td>0x4002800C</td><td>接收DMA控制寄存器</td><td>0x0000000</td></tr><tr><td>R16_ETH_ERXST</td><td>0x4002800C</td><td>接收DMA缓冲区起始地址寄存器</td><td>0x0000</td></tr><tr><td>R16_ETH_ERXLN</td><td>0x4002800E</td><td>接收长度寄存器</td><td>0x0000</td></tr><tr><td>R32_ETH_HTL</td><td>0x40028010</td><td>Hash表低字节寄存器</td><td>0x484EA033</td></tr><tr><td>R32_ETH_HTH</td><td>0x40028014</td><td>Hash表高字节寄存器</td><td>0x5000EF97</td></tr><tr><td>R32_ETH_MACON</td><td>0x40028018</td><td>接收过滤设置寄存器</td><td>0x10000000</td></tr><tr><td>R8_ETH_ERXFCON</td><td>0x40028018</td><td>接收包过滤控制寄存器</td><td>0x00</td></tr><tr><td>R8_ETH_MACON1</td><td>0x40028019</td><td>Mac层流控制寄存器</td><td>0x00</td></tr><tr><td>R8_ETH_MACON2</td><td>0x4002801A</td><td>Mac层封包控制寄存器</td><td>0x00</td></tr><tr><td>R8_ETH_MABBIPG</td><td>0x4002801B</td><td>最小包间间隔寄存器</td><td>0x10</td></tr><tr><td>R32 ETH_TIM</td><td>0x4002801C</td><td>流控制暂停帧时间寄存器</td><td>0xXXXXXXXXX</td></tr><tr><td>R16 ETH_EPAUS</td><td>0x4002801C</td><td>流控制暂停帧时间寄存器</td><td>0xXXXXXXXX</td></tr><tr><td>R16 ETH_MAMXFL</td><td>0x4002801E</td><td>最大接收包长度寄存器</td><td>0x0000</td></tr><tr><td>R16 ETH_MIRD</td><td>0x40028020</td><td>MII读数据寄存器</td><td>0x1100</td></tr><tr><td>R32 ETH_MIWR</td><td>0x40028024</td><td>MII写寄存器</td><td>0x00000000</td></tr><tr><td>R8 ETH_MIREGADR</td><td>0x40028024</td><td>MII地址寄存器</td><td>0x00</td></tr><tr><td>R8 ETH_MISTAT</td><td>0x40028025</td><td>MII状态寄存器</td><td>0x00</td></tr><tr><td>R16 ETH_MIWR</td><td>0x40028026</td><td>MII写数据寄存器</td><td>0x0000</td></tr><tr><td>R32 ETH_MAADRL</td><td>0x40028028</td><td>MAC地址低字节寄存器</td><td>0xXXXXXXXXX</td></tr><tr><td>R16 ETH_MAADRH</td><td>0x4002802C</td><td>MAC地址高字节寄存器</td><td>0xXXXXX</td></tr></table>

#### 27.2.2.1 中断使能寄存器（R8_ETH_EIE）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>7</td><td>RB ETH EIE INTIE</td><td>RW</td><td>以太网中断使能:0:关闭中断; 1:开启中断。</td><td>0</td></tr><tr><td>6</td><td>RB ETH EIE RXIE</td><td>RW</td><td>接收完成中断使能:0:关闭中断; 1:开启中断。</td><td>0</td></tr><tr><td>5</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>4</td><td>RB ETH EIE LINKIE</td><td>RW</td><td>Link变化中断使能:0:关闭中断; 1:开启中断。</td><td>0</td></tr><tr><td>3</td><td>RB ETH EIE TXIE</td><td>RW</td><td>发送完成中断使能:0:关闭中断; 1:开启中断。</td><td>0</td></tr><tr><td>2</td><td>RB ETH EIE R_EN50</td><td>RW</td><td>内置的50欧姆阻抗匹配电阻使能:0:片内电阻断开;1:片内电阻连接。</td><td>0</td></tr><tr><td>1</td><td>RB ETH EIE TXERIE</td><td>RW</td><td>发送错误中断使能:0:关闭中断; 1:开启中断。</td><td>0</td></tr><tr><td>0</td><td>RB ETH EIE RXERIE</td><td>RW</td><td>接收错误中断使能:0:关闭中断; 1:开启中断。</td><td>0</td></tr></table>

#### 27.2.2.2 中断标志寄存器（R8_ETH_EIR）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>7</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>6</td><td>RB ETH EIR RXIF</td><td>RW1</td><td>接收完成标志。</td><td>0</td></tr><tr><td>5</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>4</td><td>RB ETH EIR LINKIF</td><td>RW1</td><td>Link变化标志。</td><td>0</td></tr><tr><td>3</td><td>RB ETH EIR TXIF</td><td>RW1</td><td>发送完成标志。</td><td>0</td></tr><tr><td>2</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>1</td><td>RB ETH EIR TXERIF</td><td>RW1</td><td>发送错误标志。</td><td>0</td></tr><tr><td>0</td><td>RB ETH EIR RXERIF</td><td>RW1</td><td>接收错误标志。</td><td>0</td></tr></table>

#### 27.2.2.3 状态寄存器（R8_ETH_ESTAT）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>7</td><td>RB ETH ESTAT_INT</td><td>RW1</td><td>中断。</td><td>0</td></tr><tr><td>6</td><td>RB ETH ESTATBUFER</td><td>RW1</td><td>Buffer 错误。</td><td>0</td></tr><tr><td>5</td><td>RB ETH ESTAT RXCRCER</td><td>R0</td><td>接收CRC出错。</td><td>0</td></tr><tr><td>4</td><td>RB ETH ESTAT RXNIBBLE</td><td>R0</td><td>接收 nibble 错误。</td><td>0</td></tr><tr><td>3</td><td>RB ETH ESTAT RXMORE</td><td>R0</td><td>接收超过设定最大数据包。</td><td>0</td></tr><tr><td>2</td><td>RB ETH ESTAT RXBUSY</td><td>R0</td><td>接收进行中。</td><td>0</td></tr><tr><td>1</td><td>RB ETH ESTAT TXABRT</td><td>R0</td><td>发送被MCU打断。</td><td>0</td></tr><tr><td>0</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr></table>

#### 27.2.2.4 PHY 模拟参数设置寄存器（R8_ETH_ECON2）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[7:4]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[3:1]</td><td>RB_ETH_ECON2_RXRB_ETH_ECON2_MUST</td><td>RW</td><td>保留，必须写入011。</td><td>011b</td></tr><tr><td>0</td><td>RB_ETH_ECON2_TX</td><td>RW</td><td>发送端节能驱动控制：0：额定驱动；1：节能驱动。</td><td>0</td></tr></table>

#### 27.2.2.5 收发控制寄存器（R8_ETH_ECON1）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>7</td><td>RB ETH_ECON1_TXRST</td><td>RW</td><td>发送模块复位:0: 不复位; 1: 复位发送模块。</td><td>0</td></tr><tr><td>6</td><td>RB ETH_ECON1_RXRST</td><td>RW</td><td>接收模块复位:0: 不复位; 1: 复位接收模块。</td><td>0</td></tr><tr><td>[5:4]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>3</td><td>RB ETH_ECON1_TXRTS</td><td>RW</td><td>发送开始,发送完成后自动清零:1: 启动发送; 0: 无动作。</td><td>0</td></tr><tr><td>2</td><td>RB ETH_ECON1_RXEN</td><td>RW</td><td>接收使能控制:0: 关闭接收; 1: 开启接收。</td><td>0</td></tr><tr><td>[1:0]</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr></table>

#### 27.2.2.6 发送 DMA 缓存区地址寄存器（R16_ETH_ETXST）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:0]</td><td>R16 ETH_ETXST</td><td>RW</td><td>发送 DMA 缓冲区起始地址。低 15 位有效，地址必须 4 字节对齐。</td><td>xxxxh</td></tr></table>

#### 27.2.2.7 发送长度（R16_ETH_ETXLN）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:0]</td><td>R16 ETH ETXLN</td><td>RW</td><td>发送长度。</td><td>xxxxh</td></tr></table>

#### 27.2.2.8 接收 DMA 缓冲区地址寄存器（R16_ETH_ERXST）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:0]</td><td>R16 ETH_ERXST</td><td>RW</td><td>接收DMA缓冲区起始地址。低15位有效，地址必须4字节对齐。</td><td>xxxxh</td></tr></table>

#### 27.2.2.9 接收长度寄存器（R16_ETH_ERXLN）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:0]</td><td>R16.eth_ERXLN</td><td>R0</td><td>接收长度。</td><td>0</td></tr></table>

27.2.2.10 Hash 表低字节寄存器（R32_ETH_HTL）  

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:24]</td><td>R8 ETH EHT3</td><td>RW</td><td>Hash Table 字节 3。</td><td>xxh</td></tr><tr><td>[23:16]</td><td>R8 ETH EHT2</td><td>RW</td><td>Hash Table 字节 2。</td><td>xxh</td></tr><tr><td>[15:8]</td><td>R8 ETH EHT1</td><td>RW</td><td>Hash Table 字节 1。</td><td>xxh</td></tr><tr><td>[7:0]</td><td>R8 ETH EHT0</td><td>RW</td><td>Hash Table 字节 0。</td><td>xxh</td></tr></table>

27.2.2.11 Hash 表高字节寄存器（R32_ETH_HTH）  

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:24]</td><td>R8 ETH EHT7</td><td>RW</td><td>Hash Table 字节 7。</td><td>xxh</td></tr><tr><td>[23:16]</td><td>R8 ETH EHT6</td><td>RW</td><td>Hash Table 字节 6。</td><td>xxh</td></tr><tr><td>[15:8]</td><td>R8 ETH EHT5</td><td>RW</td><td>Hash Table 字节 5。</td><td>xxh</td></tr><tr><td>[7:0]</td><td>R8 ETH EHT4</td><td>RW</td><td>Hash Table 字节 4。</td><td>xxh</td></tr></table>

27.2.2.12 接收过滤设置寄存器（R8_ETH_ERXFCON）  

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>7</td><td>RB ETH ERXFCON_UCEN</td><td>RW</td><td>单播匹配过滤设置:0:丢弃所有单播包;1:接收目标地址匹配的包。</td><td>0</td></tr><tr><td>6</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>5</td><td>RB ETH ERXFCON_CRCEN</td><td>RW</td><td>CRC校验过滤设置:0:丢弃CRC错误的包;1:接收CRC错误的包。</td><td>0</td></tr><tr><td>4</td><td>RB ETH ERXFCON_EN</td><td>RW</td><td>接收过滤使能:0:关闭接收过滤功能;1:开启接收过滤功能。</td><td>0</td></tr><tr><td>3</td><td>RB ETH ERXFCON_MPEN</td><td>RW</td><td>魔法包过滤设置:0:丢弃魔法包;1:接收魔法包。</td><td>0</td></tr><tr><td>2</td><td>RB ETH ERXFCON_HTEN</td><td>RW</td><td>hash 表匹配过滤设置:0:丢弃hash 表匹配的包;1:接收hash 表匹配的包。</td><td>0</td></tr><tr><td>1</td><td>RB ETH ERXFCON_MCEN</td><td>RW</td><td>组播包匹配过滤设置:0:丢弃所有组播包;1:接收所有组播包。</td><td>0</td></tr><tr><td>0</td><td>RB ETH ERXFCON_BCEN</td><td>RW</td><td>广播包匹配过滤设置:0:丢弃所有广播包;1:接收所有广播包。</td><td>0</td></tr></table>

27.2.2.13 Mac 层流控制寄存器（R8_ETH_MACON1）  

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[7:6]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[5:4]</td><td>RB ETH MACON1_FCEN</td><td>RW</td><td>pause 帧设置,全双工下有效00:停止发送暂停帧;01:发送一次暂停帧,然后停止发送;10:周期性发送暂停帧;11:发送0 timer 暂停帧,然后停止发送。</td><td>00b</td></tr><tr><td>3</td><td>RB ETH MACON1_TXPAUS</td><td>RW</td><td>发送 pause 帧使能控制:0:不发送 pause 帧;1:使能发送。</td><td>0</td></tr><tr><td>2</td><td>RB ETH MACON1_RXPAUS</td><td>RW</td><td>接收 pause 帧使能:0:不接收 pause 帧;1:使能接收。</td><td>0</td></tr><tr><td>1</td><td>RB ETH MACON1_PASSAL</td><td>RW</td><td>控制帧设置:0:控制帧将被过滤;1:没被过滤的控制帧将写入缓存。</td><td>0</td></tr><tr><td>0</td><td>RB ETH MACON1_MARXEN</td><td>RW</td><td>MAC层接收使能:0:MAC不接收数据;1:MAC接收使能。</td><td>0</td></tr></table>

#### 27.2.2.14 Mac 层封包控制寄存器（R8_ETH_MACON2）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[7:5]</td><td>RB_ETH_MACON2PADCFG</td><td>RW</td><td>短包填充设置:7:所有短包填充0至64字节,再4字节CRC;6:不填充短包;5:检测到字段为8100h的VLAN网络包自动填充0至64字节,否则短包填充60字节0,填充后再4字节CRC;4:不填充短包;3:所有短包填充0至64字节,再4字节CRC;2:不填充短包;1:所有短包填充0至60字节,再4字节CRC;0:不填充短包。</td><td>0</td></tr><tr><td>4</td><td>RB_ETH_MACON2_TXCRCEN</td><td>RW</td><td>发送添加CRC控制:0:硬件不填充CRC;1:硬件填充CRC。</td><td>0</td></tr><tr><td>3</td><td>RB_ETH_MACON2_PHDREN</td><td>RW</td><td>特殊4字节不参与CRC校验。</td><td>0</td></tr><tr><td>2</td><td>RB_ETH_MACON2_HFRMEN</td><td>RW</td><td>允许接收巨型帧:0:不允许接收巨型帧;1:允许接收。</td><td>0</td></tr><tr><td>1</td><td>Reserved</td><td>RO</td><td>保留。</td><td>0</td></tr><tr><td>0</td><td>RB_ETH_MACON2_FULDPX</td><td>RW</td><td>以太网络通讯模式:0:半双工;1:全双工。</td><td>0</td></tr></table>

#### 27.2.2.15 最小包间间隔寄存器（R8_ETH_MABBIPG）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>7</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[6:0]</td><td>R8 ETH MABBIPG</td><td>RW</td><td>最小包间间隔字节数。</td><td>0010000b</td></tr></table>

#### 27.2.2.16 流控制暂停帧时间寄存器（R16_ETH_EPAUS）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:0]</td><td>R16 ETH_EPAUS</td><td>RW</td><td>流控制暂停帧时间。</td><td>XXXXh</td></tr></table>

#### 27.2.2.17 最大接收包长度寄存器（R16_ETH_MAMXFL）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:0]</td><td>R16 ETH MAMXFL</td><td>RW</td><td>最大接收包长度。</td><td>0</td></tr></table>

#### 27.2.2.18 MII 读数据寄存器（R16_ETH_MIRD）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:0]</td><td>R16 ETH MIRD</td><td>RW</td><td>MII读数据寄存器。</td><td>1100h</td></tr></table>

#### 27.2.2.19 MII 地址寄存器（R8_ETH_MIREGADR）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[7:5]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>[4:0]</td><td>RB_ETH_MIREGADR_MIRDL</td><td>RW</td><td>PHY 寄存器地址。</td><td>0</td></tr></table>

#### 27.2.2.20 MII 状态寄存器（R8_ETH_MISTAT）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[7:1]</td><td>Reserved</td><td>R0</td><td>保留。</td><td>0</td></tr><tr><td>0</td><td>R8 ETH MII STA</td><td>R0</td><td>MII寄存器操作状态:1:写MII寄存器;0:读MII寄存器</td><td>0</td></tr></table>

#### 27.2.2.21 MII 写数据寄存器（R16_ETH_MIWR）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[15:0]</td><td>R16 ETH MIWR</td><td>WO</td><td>MII写数据寄存器。</td><td>0</td></tr></table>

#### 27.2.2.22 MAC 地址寄存器（R32_ETH_MAADRL、R16_ETH_MAADRH）

<table><tr><td>位</td><td>名称</td><td>访问</td><td>描述</td><td>复位值</td></tr><tr><td>[31:0]</td><td>R32 ETH MAADRL</td><td>RW</td><td>MAC Address 字节 1~4。</td><td>x</td></tr><tr><td>[15:0]</td><td>R16 ETH MAADR H</td><td>RW</td><td>MAC Address 字节 5~6。</td><td>x</td></tr></table>

注：内部10M物理层相关寄存器内容详见27.1.8.5内部10M物理层相关寄存器地址部分。

### 27.2.3 操作指南

#### 1.初始化

（1）、配置安全寄存器进入安全模式，打开以太网络的时钟和电源；  
（2）、开启相应的中断，可选的，启动阻抗匹配电阻；  
（3）、配置接收过滤模式、CRC 功能、MAC 地址；  
（4）、设置缓存；  
（5）、启动接收，开启中断。

#### 2.发送数据

（1）、写入 R16_ETH_ETXLN 数据长度；  
（2）、写入 R16_ETH_ETXST 数据地址；  
（3）、使能 RB_ETH_ECON1_TXRTS 标志，启动发送。

#### 3.接收数据

（1）、预先设置好接收地址，使能接收；  
（2）、使用中断或查询到接收完成状态；  
（3）、读取 R16_ETH_ERXLN 接收长度；  
（4）、更新 R16_ETH_ERXST 接收地址

具体的应用请基于以太网协议栈库使用，并参考提供的网络应用示例。

