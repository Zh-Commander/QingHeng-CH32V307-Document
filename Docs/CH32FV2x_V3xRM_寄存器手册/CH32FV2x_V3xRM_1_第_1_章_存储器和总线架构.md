# 第 1 章 存储器和总线架构

## 1.1 总线架构

CH32F2x 系列是基于 ARM○R CortexTM-M3 内核设计的微控制器，其构架中的内核、仲裁单元、DMA 模块和 SRAM 存储等部分通过多组总线实现交互。

CH32V2x、CH32V3x 系列产品是基于 RISC-V 指令集设计的通用微控制器，其架构中的内核、仲裁单元、DMA模块、SRAM存储等部分通过多组总线实现交互。

![](images/510019e907c744aa299ed5403502bfdc8ada560cba201e7dbbdaa974a959fefb.jpg)  
图 1-1 CH32F203（中小容量通用型）系统框图

![](images/fad4b6d8c7576e8e985071755c9194ed52fbf2a9ff2e49c7108c1b13a73aabcd.jpg)  
图 1-2 CH32F2x（连接/互联/大容量通用型）系统框图

![](images/4551c8137c0a13c443c683353d60a005067d9f0220ee542d6264d12284b1d736.jpg)  
图 1-3 CH32F208（无线型）系统框图

![](images/b3044530fc384b8223fa9b4fc7a0f28728158cdc33cc8d9f267f4fab8bcfeeb9.jpg)  
图 1-4 CH32V203 系统框图

![](images/7b1869bacaf860244394f1409a98039183b21c3457020dda84204e2903427bed.jpg)  
图 1-5 CH32V208 系统框图

![](images/e3bf224d4d8a0e0bd161b8e1db98eaa46415fcdfc8e8393a0a7c0d5940560bff.jpg)  
图 1-6 CH32V3x 系统框图

系统中设有：Flash 访问预取机制用以加快代码执行速度；通用 DMA 控制器用以减轻 CPU 负担、提高效率；时钟树分级管理用以降低了外设总的运行功耗，同时还兼有数据保护机制，时钟安全系统保护机制等措施来增加系统稳定性。

$\bullet$ 指令总线(I-Code)将内核和 FLASH 指令接口相连，预取指在此总线上完成。  
$\bullet$ 数据总线(D-Code)将内核和 FLASH 数据接口相连，用于常量加载和调试。  
$\bullet$ 系统总线将内核和总线矩阵相连，用于协调内核、DMA、SRAM 和外设的访问。  
$\bullet$ DMA总线负责DMA的AHB主控接口与总线矩阵相连，该总线访问对象是 FLASH数据、SRAM 和外设。

总线矩阵负责的是系统总线、数据总线、DMA 总线、SRAM 和 AHB/APB 桥之间的访问协调。  
$\bullet$ AHB/APB 桥，为AHB总线和两个APB总线提供同步连接。不同的外设挂在不同的 APB总线下，可以按实际需求配置不同总线时钟，优化性能。

## 1.2 存储器映像

CH32F2x、CH32V2x 和 ${ \mathsf { C H } } 3 2 { \mathsf { V } } 3 \times$ 系列产品都包含了程序存储器、数据存储器、内核寄存器和外设寄存器等等，它们都在一个4GB的线性空间寻址。

系统存储以小端格式存放数据，即低字节存放在低地址，高字节存放在高地址。

![](images/8637a2ef3aeb2424eeabbea5ec7fc9e8111a83c8bb1045d97c14eda426e45978.jpg)  
图 1-7 CH32F203（中小容量通用型）存储映像

![](images/f3bf9c5bb4bd23fbb008a563c0ed9c3c78a096ffaa87cf860ce60a0863feb0ab.jpg)  
图 1-8 CH32F2x（连接/互联/大容量通用型）存储映像

![](images/a2f1bd053497a70783c75b2aacccaa30c926ee543564ac390acd4e7bcfb44f97.jpg)  
图 1-9 CH32F208（无线型）存储映像

![](images/3229399a9b3b3a1e587909dec237d53900759c4bfa9a701e0a2e6a224c7c210a.jpg)  
图 1-10 CH32V203 存储映像

![](images/9eb88719945b1f82da71ffcdf76eb0095a6cce925da373db43b0528f39b176d7.jpg)  
图 1-11 CH32V208 存储映像

![](images/42846b5d482f2dc0bb8b5c7df334776e6cf41218fc28521f1056075792e99a66.jpg)  
图 1-12 CH32V3x 存储映像

### 1.2.1 位段访问

位操作就是单独读写一个比特位的操作。CH32F2x产品中通过映射的处理方式提供了对外设寄存器和 SRAM区内容的位操作读写。具体方法：

1）通过对映射地址区域32位的数据进行读操作，读出的值为 0 或非 0，获取目标位域值是 0或 1；  
2）通过对映射地址区域 32 位的数据进行写操作，写入 0 或 1，修改目标位域值为 0 或 1。

地址映射：

目标位域：基地址(BEaddr) $+$ 偏移地址(Ofaddr) $^ +$ 位号(BitN)

映射地址：Mapaddr

$$
\text {M a p a d d r} = \text {B E a d d r} + 0 \times 2 0 0 0 0 0 0 + (0 \text {f a d d r} \times 3 2) + (\text {B i t N} \times 4)
$$

举例 1：对 SRAM 区的 0x20000100 地址字节中的 bit3 目标位域进行操作：

$$
\text {M a p a d d r} = 0 \times 2 0 0 0 0 0 0 0 + 0 \times 2 0 0 0 0 0 0 + (0 \times 1 0 0 * 3 2) + (3 * 4) = 0 \times 2 2 0 0 2 0 0 0
$$

则读取 $0 { \times } 2 2 0 0 2 0 0 0$ 地址的 4 字节数据内容可知 $0 { \times } 2 0 0 0 0 1 0 0$ 地址字节中的 bit3 是 0 还是 1；对$0 { \times } 2 2 0 0 2 0 0 0$ 地址执行写0或1操作，可以修改 $0 { \times } 2 0 0 0 0 1 0 0$ 地址字节中的 bit3 为 0还是1。

举例 2：对外设区域的 $0 { \times } 4 0 0 2 1 0 0 0$ 地址中的 bit24 进行操作：

$$
\text {M a p a d d r} = 0 \times 2 0 0 0 0 0 0 0 + 0 \times 2 0 0 0 0 0 0 + (0 \times 2 1 0 0 0 * 3 2) + (2 4 * 4) = 0 \times 2 2 4 2 0 0 6 0
$$

则读取 $0 { \times } 2 2 4 2 0 0 6 0$ 地址的4字节数据内容可知 $0 { \times } 4 0 0 2 1 0 0 0$ 外设地址中的 bit24是0 还是 1；对$0 { \times } 2 2 4 2 0 0 6 0$ 地址执行写0或1操作，可以修改 $0 { \times } 4 0 0 2 1 0 0 0$ 外设地址中的 bit24为 0还是1。

注：CH32V2x和CH32V3x产品不支持位段映射访问方式。

### 1.2.2 存储器分配

内置最大 128K 字节的 SRAM，起始地址 0x20000000，支持字节、半字(2 字节)、全字(4 字节)访问。

内置最大 480K 字节的程序闪存存储区(CodeFlash)，用于存储用户应用程序。

内置 28K 字节的系统存储器(bootloader)，用于存储系统引导程序（厂家固化自举加载程序）。内置 128 字节空间用于厂商配置字存储，出厂前固化，用户不可修改。

内置 128 字节空间用于用户选择字存储。

注；储存器分配各型号不同，具体参考芯片对应数据手册。

## 1.3 启动配置

系统可以通过 BOOT0 和 BOOT1 引脚来选择三种不同的启动模式。

表 1-1 启动模式  

<table><tr><td>B00T0</td><td>B00T1</td><td>启动模式</td></tr><tr><td>0</td><td>X</td><td>从程序闪存存储器启动</td></tr><tr><td>1</td><td>0</td><td>从系统存储器启动</td></tr><tr><td>1</td><td>1</td><td>从内部 SRAM 启动</td></tr></table>

用户通过设置 BOOT 引脚的状态值来选择复位后的启动模式。系统复位后或者电源复位都会导致BOOT引脚的值被重新锁存。

启动模式不同，程序闪存存储器、系统存储器和内部SRAM 有着不同的访问方式：

l 从程序闪存存储器启动时，程序闪存存储器地址被映射到 $0 \times 0 0 0 0 0 0 0 0$ 地址区域，同时也能够在原地址区域 $0 \times 0 8 0 0 0 0 0 0$ 访问。  
$\bullet$ 从系统存储器启动时，系统存储器地址被映射到 $0 \times 0 0 0 0 0 0 0 0$ 地址区域，同时也能够在原地址区域 0x1FFFF000 访问。  
$\bullet$ 从内部 SRAM 启动，只能够从 $0 { \times } 2 0 0 0 0 0 0 0$ 地址区域访问。对于 CH32F2x 系列产品，在此区域启动时，需要通过 NVIC 控制器设置向量表偏移寄存器，重映射向量表到 SRAM 中。对于 CH32V2x 和 ${ \mathsf { C H } } 3 2 { \mathsf { V } } 3 \times$ 系列产品无需此动作。

